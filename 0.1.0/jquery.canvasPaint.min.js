// version: 0.1.0
function CanvasPaintObjectFactory(a){var e=this;e.owner=a,e.drawingObject=function(a,e){return e.tool=a.tool,e.id=a.id,e.order=a.order,e.layer=a.layer,e.genCanvas=function(){e.bigCanvas=$("<canvas>").attr({height:e.layer.manager.owner.options.canvHeight,width:e.layer.manager.owner.options.canvWidth}).addClass("canvasPaintObjectCanvas").css("z-index",1e3*e.layer.order+e.order),e.layer.manager.owner.canvasDiv.append(e.bigCanvas),e.bigContext=e.bigCanvas[0].getContext("2d")},e.genCanvas(),e.delCanvas=function(){this.bigCanvas.remove(),delete this.bigContext},this},e.paintObject=function(a){return e.drawingObject(a,this),this.strokeColor=e.owner.TM.strokeColor,this.strokeWidth=e.owner.TM.strokeWidth,this.strokeOpacity=e.owner.TM.strokeOpacity||100,this.points=new Array,this.points.push({x:a.mX,y:a.mY}),this.bounds={},this.bounds.top=a.mY-a.strokeWidth/2,this.bounds.left=a.mX-a.strokeWidth/2,this.bounds.bottom=a.mY-a.strokeWidth/2,this.bounds.right=a.mX-a.strokeWidth/2,this.addPoint=function(a){this.points.push({x:a.mX,y:a.mY})},this.draw=function(){this.bigContext.clearRect(0,0,this.bigContext.canvas.width,this.bigContext.canvas.height),this.bigContext.strokeStyle=this.strokeColor,this.bigContext.globalAlpha=this.strokeOpacity*this.layer.opacity,this.bigContext.lineWidth=this.strokeWidth,this.bigContext.lineJoin="round",this.bigContext.lineCap="round",this.bigContext.beginPath();for(var a=0;a<this.points.length;a++)0==a&&(this.bigContext.moveTo(this.points[a].x,this.points[a].y),this.bigContext.lineTo(this.points[a].x+.001,this.points[a].y)),this.bigContext.lineTo(this.points[a].x,this.points[a].y);this.bigContext.stroke(),this.layer.previewContext.drawImage(this.bigCanvas[0],0,0)},this.drawOnContextAsImg=function(a){this.draw(),a.drawImage(this.bigCanvas[0],0,0)},this.show=function(){this.bigCanvas.show()},this.hide=function(){this.bigCanvas.hide()},this.setOrder=function(a){this.order=a,this.bigCanvas.css("z-index",1e3*this.layer.order+a)},this.setLayerOrder=function(){this.setOrder(this.order)},this.computeBounds=function(){this.points.forEach(function(a){})},this}}function CanvasPaintLayerManager(a){var e=this;e.owner=a,e.layers=[],e.addNewLayer=function(){e.owner.TM.addLayer.doAction({manager:e})},e.useLayer=function(a){e.currLayer&&e.currLayer.dontUse(),Number.isInteger(a)?e.getLayer(a).use():a.use()},e.useLayerClicked=function(a){e.useLayer(a.data.layer)},e.getLayer=function(a){e.layers.forEach(function(e){return a==e.id?e:void 0})},e.layer=function(){var a=this;a.manager=e,a.id=0,a.order=0,a.opacity=1,e.layers.forEach(function(e){a.id=Math.max(a.id,e.id),a.order=Math.max(a.order,e.order)}),e.layers.length&&(a.id+=1,a.order+=1),a.show=!0,a.canvasPaint=!1,a.currObj=void 0,a.genHTML=function(){a.miniLayerDiv=$("<div>").addClass("canvasPaintMiniLayerDiv").css("order",a.order).click({layer:a},e.useLayerClicked),e.owner.layersInnerDiv.append(a.miniLayerDiv),a.miniLayerDiv.append($("<strong>").html("Layer id: "+a.id));var n=$("<div>").addClass("canvasPaintLayerToolbar");a.miniLayerDiv.append(n),a.visibilityToggleButton=$("<img>").attr({src:"resources/openEye.png"}).addClass("canvasPaintImgButton").click(a.toggleShow),n.append($("<div>").addClass("canvasPaintVisibilityToggleDiv").css("order",0).append(a.visibilityToggleButton)),n.append($("<span>").html("Clear").addClass("canvasPaintImgButton").css("order",1).click({layer:this},a.clear)),n.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",2).append($("<img>").attr({src:"resources/delete.png"}).addClass("canvasPaintImgButton").click({layer:this},a.deleteLayer))),n.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",3).append($("<img>").attr({src:"resources/up.png"}).addClass("canvasPaintImgButton").click({layer:this},a.moveUp))),n.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",4).append($("<img>").attr({src:"resources/down.png"}).addClass("canvasPaintImgButton").click({layer:this},a.moveDown))),a.opacitySpan=$("<span>").html("100").addClass("canvasPaintValueSpan"),a.opacitySlider=$("<input>").attr({type:"range",min:0,max:100,value:100}).addClass("canvasPaintLayerOpacity").on("input change",a.opacityChange),n.append($("<div>").html("Layer Opacity: ").addClass("canvasPaintInputDiv").css("order",5).append(a.opacitySpan).append("%").append(a.opacitySlider)),a.previewCanvas=$("<canvas>").attr({height:e.owner.mainContext.canvas.height,width:e.owner.mainContext.canvas.width}).addClass("canvasPaintLayerPreviewCanvas"),a.miniLayerDiv.append(a.previewCanvas),a.previewContext=a.previewCanvas[0].getContext("2d")},a.actions=[],a.undone=[],a.objects=[],a.use=function(){a.miniLayerDiv.addClass("canvasPaintLelectedLayer"),e.currLayer=a},a.dontUse=function(){a.miniLayerDiv.removeClass("canvasPaintLelectedLayer")},a.clear=function(n){e.owner.TM.clear.doAction({layer:a})},a.deleteLayer=function(n){e.owner.TM.deleteLayer.doAction({layer:a})},a.moveUp=function(n){e.owner.TM.moveLayerUp.doAction({layer:a})},a.moveDown=function(n){e.owner.TM.moveLayerDown.doAction({layer:a})},a.opacityChange=function(n){var r=!0;"change"==n.type&&(r=!1),e.owner.TM.changeLayerOpacity.doAction({layer:a,dragging:r})},a.getObj=function(e){var n;for(n=0;n<a.objects.length;n++)if(a.objects[n].id==e)return a.objects[n]},a.redraw=function(){a.previewContext.clearRect(0,0,a.previewContext.canvas.width,a.previewContext.canvas.height),a.show&&a.objects.forEach(function(a){a.draw()})},a.drawOnGlobal=function(){a.show&&a.objects.forEach(function(a){a.drawOnContextAsImg(e.owner.mainContext)})},a.setOrder=function(e){a.order=e,a.miniLayerDiv.css("order",e),a.objects.forEach(function(a){a.setLayerOrder(e)})},a.toggleShow=function(){e.owner.TM.toggleLayerVisibility.doAction({layer:a})},a.genHTML()}}function CanvasPaintToolManager(a){var e=this;e.owner=a,e.currTool,e.strokeColor=e.owner.options.strokeColor,e.strokeWidth=e.owner.options.strokeWidth,e.strokeOpacity=e.owner.options.strokeOpacity,e.setTool=function(a){switch(a){case"paint":e.paint.select()}},e.paint={doAction:function(a){if(a.layer.show&&(a.dragging?a.layer.canvasPaint&&(a.layer.currObj.addPoint(a),a.layer.redraw()):(a.layer.objects>0?(a.id=0,a.layer.objects.forEach(function(e){e.id>=a.id&&(a.id=e.id+1)})):a.id=0,a.order=a.layer.objects.length,a.layer.objects.push(new a.layer.manager.owner.OF.paintObject(a)),a.layer.currObj=a.layer.objects[a.layer.objects.length-1],a.layer.actions.push({tool:"paint",obj:a.layer.currObj}),a.layer.redraw()),!a.dragging)){var n={tool:"paint",layer:a.layer};e.owner.AM.addToHistory(n)}},undo:function(a){var e=a.layer.actions.pop();return e.obj.delCanvas(),a.layer.undone.push(e),a.layer.objects.pop(),a.layer.redraw(),{tool:"paint",layer:a.layer}},redo:function(a){var e=a.layer.undone.pop();return a.layer.objects.push(e.obj),a.layer.actions.push(e),e.obj.genCanvas(),e.obj.draw(),{tool:"paint",layer:a.layer}},select:function(a){var n=e.paint,r=$("<div>").addClass("canvasPaintToolOptionDiv").css("order",0);e.owner.innerToolDiv.append(r.append($("<label>").html("Stroke Color: "))),n.strokeColor=$("<input>").attr({type:"color",value:e.strokeColor}).addClass("canvasPaintStrokeOption").on("input change",n.brushAdjusted),r.append(n.strokeColor);var t=$("<div>").css("Order",1).addClass("canvasPaintToolOptionDiv");e.owner.innerToolDiv.append(t),t.append($("<label>").html("Stroke Width: ")),n.strokeWidthSpan=$("<span>"),t.append(n.strokeWidthSpan).append("<br>"),n.strokeWidth=$("<input>").attr({type:"range",max:150,min:0,value:e.strokeWidth}).addClass("canvasPaintSlider"),t.append(n.strokeWidth),n.strokeWidth.on("input change",n.brushAdjusted),t.append("<br>"),t.append($("<label>").html("Stroke Opacity: ")),n.strokeOpacitySpan=$("<span>"),t.append(n.strokeOpacitySpan).append("%<br>"),n.strokeOpacity=$("<input>").attr({type:"range",max:100,min:0,value:e.strokeOpacity}).addClass("canvasPaintSlider"),t.append(n.strokeOpacity),n.strokeOpacity.on("input change",n.brushAdjusted),n.brushToolPreview=$("<canvas>").attr({height:150,width:150}).addClass("canvasPaintBrushPreview"),e.owner.innerToolDiv.append($("<div>").addClass("canvasPaintToolOptionDiv canvasPaintCenter").css("order",3).append(n.brushToolPreview)),n.brushAdjusted(),e.owner.paintButton.addClass("canvasPaintImgButtonSelected"),e.owner.toolNameSpan.html("Paint Brush")},brushAdjusted:function(a){var n=e.paint;e.strokeColor=n.strokeColor.val(),e.strokeWidth=n.strokeWidth.val(),e.strokeOpacity=n.strokeOpacity.val()/100,n.strokeWidthSpan.html(e.strokeWidth),n.strokeOpacitySpan.html(n.strokeOpacity.val());var r=n.brushToolPreview[0].getContext("2d");r.clearRect(0,0,r.canvas.width,r.canvas.height),r.fillStyle=e.strokeColor,r.globalAlpha=e.strokeOpacity,r.beginPath(),r.arc(r.canvas.width/2,r.canvas.height/2,e.strokeWidth/2,0,2*Math.PI),r.fill()},drawTool:function(){e.owner.mainContext.fillStyle=e.strokeColor,e.owner.mainContext.globalAlpha=e.strokeOpacity,e.owner.mainContext.beginPath(),e.owner.mainContext.arc(e.owner.mousePosition.x,e.owner.mousePosition.y,e.strokeWidth/2,0,2*Math.PI),e.owner.mainContext.fill()}},e.addLayer={doAction:function(a){var n=a.manager;n.layers.push(new n.layer),n.useLayer(n.layers[n.layers.length-1]),n.currLayer.actions.push({tool:"addLayer",layer:n.currLayer}),e.owner.AM.addToHistory({tool:"addLayer",layer:n.currLayer})},undo:function(a){var e=a.layer,n=(e.manager,e.actions.pop());e.miniLayerDiv.remove();var r,t=!1,o=e.manager.currLayer.id==e.id;for(r=0;r<e.manager.layers.length;r++)e.manager.layers[r].id==e.id&&(e.manager.layers.splice(r,1),t=!0,o&&(0!=r?e.manager.useLayer(e.manager.layers[r-1]):r<e.manager.layers.length?e.manager.useLayer(e.manager.layers[r]):e.manager.currLayer=void 0)),t&&r<e.manager.layers.length&&e.manager.layers[r].setOrder(r);return e.undone.push(n),a},redo:function(a){var e=a.layer,n=e.manager,r=e.undone.pop();e.manager.layers.splice(e.order,0,e),e.genHTML();for(var t=0;t<e.manager.layers.length;t++)e.manager.layers[t].setOrder(t);return r.wasCurr&&e.manager.useLayer(e),n.useLayer(e),e.redraw(),e.actions.push(r),a}},e.toggleLayerVisibility={doAction:function(a){lbase=a.layer,this.action(lbase),lbase.actions.push({tool:"toggleLayerVisibility",layer:lbase}),e.owner.AM.addToHistory({tool:"toggleLayerVisibility",layer:lbase})},undo:function(a){return lbase=a.layer,this.action(lbase),lbase.undone.push(lbase.actions.pop()),a},redo:function(a){return lbase=a.layer,this.action(lbase),lbase.actions.push(lbase.undone.pop()),a},action:function(a){a.show=!a.show,a.show?(a.visibilityToggleButton.attr("src","openEye.png"),a.objects.forEach(function(a){a.show()})):(a.visibilityToggleButton.attr("src","closedEye.png"),a.objects.forEach(function(a){a.hide()}))}},e.clear={doAction:function(a){a.layer.actions.push({tool:"clear",objects:a.layer.objects.slice()}),a.layer.objects.forEach(function(a){a.delCanvas()}),a.layer.objects=[],e.owner.AM.addToHistory({tool:"clear",layer:a.layer}),a.layer.redraw()},undo:function(a){var e=a.layer.actions.pop();return a.layer.objects=e.objects,a.layer.objects.forEach(function(a){a.genCanvas()}),a.layer.undone.push({tool:"clear"}),a.layer.redraw(),{tool:"clear",layer:a.layer}},redo:function(a){a.layer.undone.pop();return a.layer.actions.push({tool:"clear",objects:a.layer.objects.slice()}),a.layer.objects.forEach(function(a){a.delCanvas()}),a.layer.objects=[],a.layer.redraw(),{tool:"clear",layer:a.layer}}},e.deleteLayer={doAction:function(a){a.layer.miniLayerDiv.remove();for(var n=!1,r=a.layer.manager.currLayer.id==a.layer.id,t=0;t<a.layer.manager.layers.length;t++)a.layer.manager.layers[t].id==a.layer.id&&(a.layer.manager.layers.splice(t,1),n=!0,r&&(0!=t?a.layer.manager.useLayer(a.layer.manager.layers[t-1]):t<a.layer.manager.layers.length?a.layer.manager.useLayer(a.layer.manager.layers[t]):a.layer.manager.currLayer=void 0)),n&&t<a.layer.manager.layers.length&&a.layer.manager.layers[t].setOrder(t);a.layer.objects.forEach(function(a){a.delCanvas()}),a.layer.actions.push({tool:"deleteLayer",layer:a.layer,wasCurr:r}),e.owner.AM.addToHistory({tool:"deleteLayer",layer:a.layer})},undo:function(a){var e=a.layer.actions.pop();e.layer.manager.layers.splice(e.layer.order,0,e.layer),e.layer.genHTML(),e.layer.objects.forEach(function(a){a.genCanvas()}),e.layer.undone.push(e);for(var n=0;n<e.layer.manager.layers.length;n++)console.log(n),e.layer.manager.layers[n].setOrder(n);return e.wasCurr&&e.layer.manager.useLayer(e.layer),e.layer.redraw(),a},redo:function(a){var e=a.layer.undone.pop();e.layer.miniLayerDiv.remove();var n,r=!1,t=e.layer.manager.currLayer.id==e.layer.id;for(n=0;n<e.layer.manager.layers.length;n++)e.layer.manager.layers[n].id==e.layer.id&&(e.layer.manager.layers.splice(n,1),r=!0,t&&(0!=n?e.layer.manager.useLayer(e.layer.manager.layers[n-1]):n<e.layer.manager.layers.length?e.layer.manager.useLayer(e.layer.manager.layers[n]):e.layer.manager.currLayer=void 0)),r&&n<e.layer.manager.layers.length&&e.layer.manager.layers[n].setOrder(n);return e.layer.objects.forEach(function(a){a.delCanvas()}),e.layer.actions.push(e),a}},e.moveLayerUp={doAction:function(a){for(var n=a.layer,r=n.manager,t=0;t<r.layers.length;t++)if(r.layers[t].id==n.id&&t<r.layers.length-1)return r.layers[t]=r.layers[t+1],r.layers[t+1]=n,n.setOrder(t+1),r.layers[t].setOrder(t),n.actions.push({tool:"moveLayerUp",layer:n}),void e.owner.AM.addToHistory({tool:"moveLayerUp",layer:n})},undo:function(a){for(var e=a.layer,n=e.manager,r=e.actions.pop(),t=0;t<n.layers.length;t++)if(n.layers[t].id==e.id&&t>0)return n.layers[t]=n.layers[t-1],n.layers[t-1]=e,e.setOrder(t-1),n.layers[t].setOrder(t),e.undone.push(r),a},redo:function(a){for(var e=a.layer,n=e.manager,r=e.undone.pop(),t=0;t<n.layers.length;t++)if(n.layers[t].id==e.id&&t<n.layers.length-1)return n.layers[t]=n.layers[t+1],n.layers[t+1]=e,e.setOrder(t+1),n.layers[t].setOrder(t),e.actions.push(r),a}},e.moveLayerDown={doAction:function(a){for(var n=a.layer,r=n.manager,t=0;t<r.layers.length;t++)if(r.layers[t].id==n.id&&t>0)return r.layers[t]=r.layers[t-1],r.layers[t-1]=n,n.setOrder(t-1),r.layers[t].setOrder(t),n.actions.push({tool:"moveLayerDown",layer:n}),void e.owner.AM.addToHistory({tool:"moveLayerDown",layer:n})},undo:function(a){for(var e=a.layer,n=e.manager,r=e.undone.pop(),t=0;t<n.layers.length;t++)if(n.layers[t].id==e.id&&t<n.layers.length-1)return n.layers[t]=n.layers[t+1],n.layers[t+1]=e,e.setOrder(t+1),n.layers[t].setOrder(t),e.actions.push(r),a},redo:function(a){for(var e=a.layer,n=e.manager,r=e.undone.pop(),t=0;t<n.layers.length;t++)if(n.layers[t].id==e.id&&t>0)return n.layers[t]=n.layers[t-1],n.layers[t-1]=e,e.setOrder(t-1),n.layers[t].setOrder(t),e.actions.push(r),a}},e.changeLayerOpacity={doAction:function(a){var n=a.layer,r=n.opacitySlider.val()/100;console.log(n.opacitySlider.val()),console.log(n.opacitySlider.val()/100),console.log(r);var t=n.actions[n.actions.length-1];a.dragging?"changeLayerOpacity"==t.tool&&t.dragging?t.valueTo=r:(n.actions.push({tool:"changeLayerOpacity",dragging:!0,valueTo:r,valueFrom:n.opacity}),e.owner.AM.addToHistory({tool:"changeLayerOpacity",layer:n})):"changeLayerOpacity"==t.tool&&t.dragging?(t.valueTo=r,t.dragging=!1):(n.actions.push({tool:"changeLayerOpacity",dragging:!1,valueTo:r,valueFrom:n.opacity}),e.owner.AM.addToHistory({tool:"changeLayerOpacity",layer:n})),n.opacity=r,n.opacitySpan.html(n.opacitySlider.val()),n.redraw()},undo:function(a){var e=a.layer,n=e.actions.pop();return console.log(n),e.opacity=n.valueFrom,e.opacitySpan.html(Math.round(100*n.valueFrom)),e.opacitySlider.val(100*n.valueFrom),e.undone.push(n),e.redraw(),a},redo:function(a){var e=a.layer,n=e.undone.pop();return console.log(n),e.opacity=n.valueTo,e.opacitySpan.html(Math.round(100*n.valueTo)),e.opacitySlider.val(100*n.valueTo),e.actions.push(n),e.redraw(),a}},e.currTool=e.paint}function CanvasPaintActionManager(a){this.owner=a,this.history=new Array,this.future=new Array,this.historyLimit=100,this.addToHistory=function(a){this.history.push(a),this.future.length>0&&(this.future=[]),this.history.length>this.historyLimit&&this.history.shift()},this.undo=function(){if(this.history.length>0){var a=this.history.pop();this.future.push(this.getTool(a.tool).undo(a))}},this.redo=function(){if(this.future.length>0){var a=this.future.pop();this.history.push(this.getTool(a.tool).redo(a))}},this.getTool=function(a){switch(a){case"paint":return this.owner.TM.paint;case"clear":return this.owner.TM.clear;case"addLayer":return this.owner.TM.addLayer;case"toggleLayerVisibility":return this.owner.TM.toggleLayerVisibility;case"deleteLayer":return this.owner.TM.deleteLayer;case"moveLayerUp":return this.owner.TM.moveLayerUp;case"moveLayerDown":return this.owner.TM.moveLayerDown;case"changeLayerOpacity":return this.owner.TM.changeLayerOpacity}}}!function(a,e,n){a.boglePlugin||(a.boglePlugin={});var r=a("<link>");a("head").append(r),r.attr({rel:"stylesheet",type:"text/css",href:"resources/canvasPaint.css"}),a.boglePlugin.drawing=function(n,r,t){var o=this;o.$el=a(n),o.el=n,o.$el.data("boglePlugin.drawing",o),o.init=function(){o.functionParam=r,o.options=a.extend({},a.boglePlugin.drawing.defaultOptions,t),o.mousePosition={},o.AM=new CanvasPaintActionManager(o),o.TM=new CanvasPaintToolManager(o),o.OF=new CanvasPaintObjectFactory(o),o.LM=new CanvasPaintLayerManager(o);var e=a("<section>").addClass("canvasPaintMain");o.$el.append(e);var n=a("<section>").addClass("canvasPaintTopSect");e.append(n);var i=a("<div>").addClass("canvasPaintTopToolbar");n.append(i);var s=a("<div>").addClass("canvasPaintToolGroup");i.append(s),s.append(a("<label>").html("Export as:")),o.exportFilename=a("<input>").attr({type:"text",placeholder:"drawing"}).addClass("canvasPaintExportFilename"),s.append(o.exportFilename),s.append(".png"),o.exportButton=a("<span>").html("Export").addClass("canvasPaintImgButton").click(o.exportDrawing),s.append(o.exportButton);var l=a("<div>").addClass("canvasPaintToolGroup");i.append(l),o.undoButton=a("<img>").attr({src:"resources/undo.png"}).addClass("canvasPaintImgButton").click(o.undo),l.append(o.undoButton),l.append(" "),o.undoButton=a("<img>").attr({src:"resources/redo.png"}).addClass("canvasPaintImgButton").click(o.redo),l.append(o.undoButton);var d=a("<div>").addClass("canvasPaintToolGroup");o.paintButton=a("<img>").attr({src:"resources/brush.png"}).addClass("canvasPaintImgButton").click({tool:"paint"},o.selectTool),i.append(d.append(o.paintButton));var c=a("<section>").addClass("canvasPaintMiddleSect");e.append(c);var y=a("<div>").addClass("canvasPaintLayersOuterDiv").css("order",0);c.append(y),y.append(a("<strong>").html("Layers ")),o.addNewLayerButton=a("<img>").attr({src:"resources/add.png"}).addClass("canvasPaintImgButton"),y.append(o.addNewLayerButton),o.addNewLayerButton.click(o.addNewLayer);var u=a("<div>").addClass("canvasPaintLayersScrollingDiv");y.append(u),o.layersInnerDiv=a("<div>").addClass("canvasPaintLayersInnerDiv"),u.append(o.layersInnerDiv),o.canvasDiv=a("<div>").addClass("canvasPaintMainCanvasDiv").css("order",1),o.canvasScrollingDiv=a("<div>").addClass("canvasPaintMainCanvasScrollingDiv"),o.canvasInnerDiv=a("<div>").addClass("canvasPaintMainCanvasInnerDiv"),o.canvasDiv.append(o.canvasScrollingDiv.append(o.canvasInnerDiv)),c.append(o.canvasDiv),o.mainCanvas=a("<canvas>").attr({height:o.options.canvHeight,width:o.options.canvWidth}).addClass("canvasPaintMainCanvas"),o.canvasInnerDiv.append(o.mainCanvas),o.mainContext=o.mainCanvas[0].getContext("2d"),o.mainCanvas.on("mousedown mousemove touchstart touchmove",o.canvasMouseDownMove),o.mainCanvas.on("mouseup mouseleave touchend",o.canvasMouseUpLeave),o.mainCanvas.on("contextmenu",o.canvasContextMenu);var p=a("<div>").addClass("canvasPaintToolsOuterDiv").css("order",2);c.append(p),o.toolNameSpan=a("<span>"),p.append(o.toolNameSpan).append(" settings"),o.scrollingToolDiv=a("<div>").addClass("canvasPaintToolsScrollingDiv"),o.innerToolDiv=a("<div>").addClass("canvasPaintToolsInnerDiv"),p.append(o.scrollingToolDiv.append(o.innerToolDiv)),a("body").keydown(o.keyDown),o.addNewLayer(),o.TM.setTool(o.options.currTool),console.log("Bogle Drawing: Ready to draw!")},o.addNewLayer=function(){o.LM.addNewLayer()},o.undo=function(a){o.AM.undo()},o.redo=function(a){o.AM.redo()},o.keyDown=function(a){a=a||e.event,90!=a.keyCode&&90!=a.which||!a.ctrlKey||o.undo(),89!=a.keyCode&&89!=a.which||!a.ctrlKey||o.redo()},o.exportDrawing=function(a){o.mainContext.clearRect(0,0,o.mainContext.canvas.width,o.mainContext.canvas.height),o.mainContext.globalAlpha=1,o.LM.layers.forEach(function(a){a.drawOnGlobal()}),o.mainCanvas[0].toBlobHD(function(a){saveAs(a,(o.exportFilename.val()||o.exportFilename.attr("placeholder"))+".png")},"image/png"),o.mainContext.clearRect(0,0,o.mainContext.canvas.width,o.mainContext.canvas.height)},o.getMousePosition=function(a){if("mouseleave"==a.type)return void(o.mousePosition.offCanvas=!0);o.mousePosition.offCanvas=!1;var e=o.mainCanvas[0].getBoundingClientRect();"touchstart"==a.type||"touchmove"==a.type?(o.mousePosition.x=a.originalEvent.changedTouches[0].clientX-e.left,o.mousePosition.y=a.originalEvent.changedTouches[0].clientY-e.top):(o.mousePosition.x=a.clientX-e.left,o.mousePosition.y=a.clientY-e.top)},o.canvasMouseDownMove=function(a){if(a.preventDefault(),o.getMousePosition(a),!(a.which>1)){var e;"mousedown"==a.type||"touchstart"==a.type?(e=!1,o.LM.currLayer.canvasPaint=!0):("mousemove"==a.type||"touchmove"==a.type)&&(e=!0);var n={layer:o.LM.currLayer,mX:o.mousePosition.x,mY:o.mousePosition.y,dragging:e};o.TM.currTool.doAction(n),o.redrawBrush()}},o.canvasMouseUpLeave=function(a){o.LM.currLayer.canvasPaint&&a.which<=1&&(o.LM.currLayer.canvasPaint=!1),o.getMousePosition(a),o.redrawBrush()},this.canvasContextMenu=function(a){a.preventDefault()},o.drawBrush=function(){o.mousePosition.offCanvas||o.TM.currTool.drawTool()},o.redrawBrush=function(){o.mainContext.clearRect(0,0,o.mainContext.canvas.width,o.mainContext.canvas.height),o.drawBrush()},o.init()},a.boglePlugin.drawing.defaultOptions={canvWidth:700,canvHeight:394,currTool:"paint",strokeColor:"#ff0000",strokeWidth:20,strokeOpacity:100},a.fn.boglePlugin_drawing=function(e,n){return this.each(function(){new a.boglePlugin.drawing(this,e,n)})},a(e).ready(function(){a(".canvasPaint").boglePlugin_drawing()})}(jQuery);