// canvasPaint Plugin: 0.3.0
function CanvasPaintObjectFactory(e){var a=this;a.owner=e,a.drawingObject=function(e,a){return a.tool=e.tool,a.id=e.id,a.order=e.order,a.layer=e.layer,a.erased=[],a.genCanvas=function(){a.bigCanvas=$("<canvas>").attr({height:a.layer.manager.owner.options.canvHeight,width:a.layer.manager.owner.options.canvWidth}).addClass("canvasPaintObjectCanvas").css("z-index",1e3*a.layer.order+a.order),a.layer.manager.owner.canvasDiv.append(a.bigCanvas),a.bigContext=a.bigCanvas[0].getContext("2d")},a.genCanvas(),a.delCanvas=function(){this.bigCanvas.remove(),delete this.bigContext},this},a.paintObject=function(e){return a.drawingObject(e,this),this.type="paint",this.strokes=[],this.strokes.push({points:[{x:e.mX,y:e.mY}],tool:e.tool,strokeColor:a.owner.TM.strokeColor,strokeWidth:a.owner.TM.strokeWidth,strokeOpacity:a.owner.TM.strokeOpacity,bounds:{left:e.mX-a.owner.TM.strokeWidth/2,top:e.mY-a.owner.TM.strokeWidth/2,right:e.mX+a.owner.TM.strokeWidth/2,bottom:e.mY+a.owner.TM.strokeWidth/2}}),this.bounds={points:{}},this.bounds.points.left=e.mX-this.strokes[0].strokeWidth/2,this.bounds.points.top=e.mY-this.strokes[0].strokeWidth/2,this.bounds.points.right=e.mX+this.strokes[0].strokeWidth/2,this.bounds.points.bottom=e.mY+this.strokes[0].strokeWidth/2,this.addPoint=function(e){if(e.dragging){var t=this.strokes[this.strokes.length-1];t.points.push({x:e.mX,y:e.mY});var o=t.strokeWidth/2;e.mX-o<t.bounds.left&&(t.bounds.left=e.mX-o),e.mY-o<t.bounds.top&&(t.bounds.top=e.mY-o),e.mX+o>t.bounds.right&&(t.bounds.right=e.mX+o),e.mY+o>t.bounds.bottom&&(t.bounds.bottom=e.mY+o)}else this.strokes.push({points:[{x:e.mX,y:e.mY}],tool:e.tool,strokeColor:a.owner.TM.strokeColor,strokeWidth:a.owner.TM.strokeWidth,strokeOpacity:a.owner.TM.strokeOpacity,bounds:{left:e.mX-a.owner.TM.strokeWidth/2,top:e.mY-a.owner.TM.strokeWidth/2,right:e.mX+a.owner.TM.strokeWidth/2,bottom:e.mY+a.owner.TM.strokeWidth/2}})},this.draw=function(){if(!this.isBlank){this.bigContext.clearRect(0,0,this.bigContext.canvas.width,this.bigContext.canvas.height),this.bigContext.lineJoin="round",this.bigContext.lineCap="round";for(var e=0;e<this.strokes.length;e++){this.bigContext.beginPath(),this.bigContext.strokeStyle=this.strokes[e].strokeColor,this.bigContext.globalAlpha=this.strokes[e].strokeOpacity*this.layer.opacity,this.bigContext.lineWidth=this.strokes[e].strokeWidth,"paint"==this.strokes[e].tool?this.bigContext.globalCompositeOperation="source-over":"eraser"==this.strokes[e].tool&&(this.bigContext.globalCompositeOperation="destination-out");for(var t=0;t<this.strokes[e].points.length;t++)0==t&&(this.bigContext.moveTo(this.strokes[e].points[t].x,this.strokes[e].points[t].y),this.bigContext.lineTo(this.strokes[e].points[t].x+.001,this.strokes[e].points[t].y)),this.bigContext.lineTo(this.strokes[e].points[t].x,this.strokes[e].points[t].y);this.bigContext.stroke()}this.layer.previewContext.drawImage(this.bigCanvas[0],0,0),this.bigCanvas[0].toDataURL()==a.owner.LM.blankData&&(this.isBlank=!0)}},this.drawOnContextAsImg=function(e){this.draw(),e.drawImage(this.bigCanvas[0],0,0)},this.show=function(){this.bigCanvas.show()},this.hide=function(){this.bigCanvas.hide()},this.setOrder=function(e){this.order=e,this.bigCanvas.css("z-index",1e3*this.layer.order+e)},this.setLayerOrder=function(){this.setOrder(this.order)},this.computePointsBounds=function(){var e=(this.bigContext,this.bounds.points);e.left=void 0,e.top=void 0,e.right=void 0,e.bottom=void 0,this.strokes.forEach(function(a){"paint"==a.tool&&((!e.left||a.bounds.left<e.left)&&(e.left=a.bounds.left),(!e.top||a.bounds.top<e.top)&&(e.top=a.bounds.top),(!e.right||a.bounds.right>e.right)&&(e.right=a.bounds.right),(!e.bottom||a.bounds.bottom>e.bottom)&&(e.bottom=a.bounds.bottom))})},this.drawPointsBoundingBox=function(){this.bigContext.setLineDash([6]),this.bigContext.lineWidth=4,this.bigContext.strokeStyle="#000000",this.bigContext.beginPath(),this.bigContext.globalCompositeOperation="source-over",this.bigContext.rect(this.bounds.points.left,this.bounds.points.top,this.bounds.points.right-this.bounds.points.left,this.bounds.points.bottom-this.bounds.points.top),this.bigContext.stroke(),this.bigContext.setLineDash([0])},this}}function CanvasPaintLayerManager(e){var a=this;a.owner=e,a.layers=[],a.blankData,a.addNewLayer=function(){a.owner.TM.addLayer.doAction({manager:a})},a.useLayer=function(e){a.currLayer&&a.currLayer.dontUse(),Number.isInteger(e)?a.getLayer(e).use():e.use()},a.useLayerClicked=function(e){a.useLayer(e.data.layer)},a.getLayer=function(e){a.layers.forEach(function(a){return e==a.id?a:void 0})},a.layer=function(){var e=this;e.manager=a,e.id=0,e.order=0,e.opacity=1,e.erased=[],a.layers.forEach(function(a){e.id=Math.max(e.id,a.id),e.order=Math.max(e.order,a.order)}),a.layers.length&&(e.id+=1,e.order+=1),e.show=!0,e.canvasPaint=!1,e.currObj=void 0,e.genHTML=function(){e.miniLayerDiv=$("<div>").addClass("canvasPaintMiniLayerDiv").css("order",e.order).click({layer:e},a.useLayerClicked),a.owner.layersInnerDiv.append(e.miniLayerDiv),e.miniLayerDiv.append($("<strong>").html("Layer id: "+e.id));var t=$("<div>").addClass("canvasPaintLayerToolbar");e.miniLayerDiv.append(t),e.visibilityToggleButton=$("<img>").attr({src:"resources/openEye.png",alt:"Hide Layer",title:"Hide Layer"}).addClass("canvasPaintImgButton").click(e.toggleShow),t.append($("<div>").addClass("canvasPaintVisibilityToggleDiv").css("order",0).append(e.visibilityToggleButton)),t.append($("<span>").html("Clear").addClass("canvasPaintImgButton").css("order",1).click({layer:this},e.clear)),t.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",2).append($("<img>").attr({src:"resources/delete.png",alt:"Delete Layer",title:"Delete Layer"}).addClass("canvasPaintImgButton").click({layer:this},e.deleteLayer))),t.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",3).append($("<img>").attr({src:"resources/up.png",alt:"Move Layer Up",title:"Move Layer Up"}).addClass("canvasPaintImgButton").click({layer:this},e.moveUp))),t.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",4).append($("<img>").attr({src:"resources/down.png",alt:"Move Layer Down",title:"Move Layer Down"}).addClass("canvasPaintImgButton").click({layer:this},e.moveDown))),e.opacitySpan=$("<span>").html("100").addClass("canvasPaintValueSpan"),e.opacitySlider=$("<input>").attr({type:"range",min:0,max:100,value:100}).addClass("canvasPaintLayerOpacity").on("input change",e.opacityChange),t.append($("<div>").html("Layer Opacity: ").addClass("canvasPaintInputDiv").css("order",5).append(e.opacitySpan).append("%").append(e.opacitySlider)),e.previewCanvas=$("<canvas>").attr({height:a.owner.mainContext.canvas.height,width:a.owner.mainContext.canvas.width}).addClass("canvasPaintLayerPreviewCanvas"),e.miniLayerDiv.append(e.previewCanvas),e.previewContext=e.previewCanvas[0].getContext("2d")},e.actions=[],e.undone=[],e.objects=[],e.use=function(){e.miniLayerDiv.addClass("canvasPaintLelectedLayer"),a.currLayer=e},e.dontUse=function(){e.miniLayerDiv.removeClass("canvasPaintLelectedLayer")},e.clear=function(t){a.owner.TM.clear.doAction({layer:e})},e.deleteLayer=function(t){a.owner.TM.deleteLayer.doAction({layer:e})},e.moveUp=function(t){a.owner.TM.moveLayerUp.doAction({layer:e})},e.moveDown=function(t){a.owner.TM.moveLayerDown.doAction({layer:e})},e.opacityChange=function(t){var o=!0;"change"==t.type&&(o=!1),a.owner.TM.changeLayerOpacity.doAction({layer:e,dragging:o})},e.getObj=function(a){var t;for(t=0;t<e.objects.length;t++)if(e.objects[t].id==a)return e.objects[t]},e.redraw=function(){e.previewContext.clearRect(0,0,e.previewContext.canvas.width,e.previewContext.canvas.height),e.show&&e.objects.forEach(function(e){e.draw()})},e.drawOnGlobal=function(){e.show&&e.objects.forEach(function(e){e.drawOnContextAsImg(a.owner.mainContext)})},e.setOrder=function(a){e.order=a,e.miniLayerDiv.css("order",a),e.objects.forEach(function(e){e.setLayerOrder(a)})},e.toggleShow=function(){a.owner.TM.toggleLayerVisibility.doAction({layer:e})},e.genHTML()}}function CanvasPaintActionManager(e){this.owner=e,this.history=new Array,this.future=new Array,this.historyLimit=100,this.addToHistory=function(e){if(this.history.push(e),this.future.length>0&&(this.future.forEach(function(e){e.layer.undone=[]}),this.future=[]),this.history.length>this.historyLimit){var a=this.history.shift();a.layer.actions.shift()}},this.undo=function(){if(this.history.length>0){var e=this.history.pop();this.future.push(this.owner.TM.getTool(e.tool).undo(e))}},this.redo=function(){if(this.future.length>0){var e=this.future.pop();this.history.push(this.owner.TM.getTool(e.tool).redo(e))}}}function CanvasPaintToolManager(e){var a=this;a.owner=e,a.currTool,a.strokeColor=a.owner.options.strokeColor,a.strokeWidth=a.owner.options.strokeWidth,a.strokeOpacity=a.owner.options.strokeOpacity/100,a.setTool=function(e){a.currTool&&a.currTool.unselect(),e.data.tool.select()},a.getTool=function(e){switch(e){case"paint":return a.paint;case"eraser":return a.eraser;case"clear":return a.clear;case"addLayer":return a.addLayer;case"toggleLayerVisibility":return a.toggleLayerVisibility;case"deleteLayer":return a.deleteLayer;case"moveLayerUp":return a.moveLayerUp;case"moveLayerDown":return a.moveLayerDown;case"changeLayerOpacity":return a.changeLayerOpacity}},a.setUpTools=function(){a.toolNameSpan=$("<span>"),a.owner.outerToolDiv.append(a.toolNameSpan).append(" Settings"),a.scrollingToolDiv=$("<div>").addClass("canvasPaintToolsScrollingDiv"),a.owner.outerToolDiv.append(a.scrollingToolDiv),a.addTopToolBar(),a.addExportTools(0),a.addHistoryTools(1),a.addDrawingIcons(2),a.setTool({data:{tool:a.getTool(a.owner.options.currTool)}})},a.addTopToolBar=function(){a.topToolbar=$("<div>").addClass("canvasPaintTopToolbar"),a.owner.topSect.append(a.topToolbar)},a.addExportTools=function(e){a.exportToolGroup=$("<div>").addClass("canvasPaintToolGroup").css("order",e),a.topToolbar.append(a.exportToolGroup),a["export"].addIcon(0)},a.addHistoryTools=function(e){a.historyToolGroup=$("<div>").addClass("canvasPaintToolGroup").css("order",e),a.topToolbar.append(a.historyToolGroup),a.history.addIcon(0)},a.addDrawingIcons=function(e){a.drawingToolsGroup=$("<div>").addClass("canvasPaintToolGroup").css("order",e),a.topToolbar.append(a.drawingToolsGroup),a.paint.addIcon(0),a.eraser.addIcon(1)},a.paint={doAction:function(e){var t=e.layer;if(t.show&&(!t.currObj||"paint"==t.currObj.type)&&(e.tool="paint",0==t.objects.length?(t.objects.push(new a.owner.OF.paintObject(e)),t.currObj=t.objects[0]):t.currObj.addPoint(e),t.redraw(),!e.dragging)){var o={tool:"paint",layer:e.layer,obj:t.currObj,stroke:t.currObj.strokes[t.currObj.strokes.length-1]};t.actions.push(o),a.owner.AM.addToHistory({tool:"paint",layer:e.layer})}},undo:function(e){var a=e.layer.actions.pop();return 1==a.obj.strokes.length?(a.obj.delCanvas(),a.layer.objects.pop()):a.obj.strokes.pop(),e.layer.undone.push(a),e.layer.redraw(),e},redo:function(e){var a=e.layer.undone.pop();return a.stroke==a.obj.strokes[0]?(a.layer.objects.push(a.obj),a.obj.genCanvas()):a.obj.strokes.push(a.stroke),e.layer.actions.push(a),e.layer.redraw(),e},select:function(e){var t=a.paint;t.innerToolDiv=$("<div>").addClass("canvasPaintToolsInnerDiv"),a.scrollingToolDiv.append(t.innerToolDiv);var o=$("<div>").addClass("canvasPaintToolOptionDiv").css("order",0);t.innerToolDiv.append(o.append($("<label>").html("Stroke Color: "))),t.strokeColor=$("<input>").attr({type:"color",value:a.strokeColor}).addClass("canvasPaintStrokeOption").on("input change",t.brushAdjusted),o.append(t.strokeColor);var r=$("<div>").css("Order",1).addClass("canvasPaintToolOptionDiv");t.innerToolDiv.append(r),r.append($("<label>").html("Stroke Width: ")),t.strokeWidthSpan=$("<span>"),r.append(t.strokeWidthSpan).append("<br>"),t.strokeWidth=$("<input>").attr({type:"range",max:150,min:0,value:a.strokeWidth}).addClass("canvasPaintSlider"),r.append(t.strokeWidth),t.strokeWidth.on("input change",t.brushAdjusted),r.append("<br>"),r.append($("<label>").html("Stroke Opacity: ")),t.strokeOpacitySpan=$("<span>"),r.append(t.strokeOpacitySpan).append("%<br>"),t.strokeOpacity=$("<input>").attr({type:"range",max:100,min:0,value:100*a.strokeOpacity}).addClass("canvasPaintSlider"),r.append(t.strokeOpacity),t.strokeOpacity.on("input change",t.brushAdjusted),t.brushToolPreview=$("<canvas>").attr({height:150,width:150}).addClass("canvasPaintBrushPreview"),t.innerToolDiv.append($("<div>").addClass("canvasPaintToolOptionDiv canvasPaintCenter").css("order",3).append(t.brushToolPreview)),t.brushAdjusted(),t.icon.addClass("canvasPaintImgButtonSelected"),a.toolNameSpan.html("Paint Brush"),a.currTool=t},unselect:function(){var e=a.paint;e.icon.removeClass("canvasPaintImgButtonSelected"),e.innerToolDiv.remove()},addIcon:function(e){pBase=a.paint,pBase.icon=$("<img>").css("order",e).attr({src:"resources/brush.png",alt:"Paint Brush",title:"Paint Brush"}).addClass("canvasPaintImgButton").click({tool:pBase},a.setTool),a.drawingToolsGroup.append(pBase.icon)},brushAdjusted:function(e){var t=a.paint;a.strokeColor=t.strokeColor.val(),a.strokeWidth=t.strokeWidth.val(),a.strokeOpacity=t.strokeOpacity.val()/100,t.strokeWidthSpan.html(a.strokeWidth),t.strokeOpacitySpan.html(t.strokeOpacity.val());var o=t.brushToolPreview[0].getContext("2d");o.clearRect(0,0,o.canvas.width,o.canvas.height),o.fillStyle=a.strokeColor,o.globalAlpha=a.strokeOpacity,o.beginPath(),o.arc(o.canvas.width/2,o.canvas.height/2,a.strokeWidth/2,0,2*Math.PI),o.fill()},drawTool:function(){a.owner.mainContext.fillStyle=a.strokeColor,a.owner.mainContext.globalAlpha=a.strokeOpacity,a.owner.mainContext.beginPath(),a.owner.mainContext.arc(a.owner.mousePosition.x,a.owner.mousePosition.y,a.strokeWidth/2,0,2*Math.PI),a.owner.mainContext.fill()}},a.eraser={doAction:function(e){var t=(a.eraser,e.layer);if(t.show&&0!=t.objects.length&&(e.tool="eraser","paint"==t.currObj.type&&t.currObj.addPoint(e),t.redraw(),!e.dragging)){var o={tool:"eraser",layer:e.layer,obj:t.currObj,stroke:t.currObj.strokes[t.currObj.strokes.length-1]};t.actions.push(o),a.owner.AM.addToHistory({tool:"eraser",layer:e.layer})}},undo:function(e){var a=e.layer.actions.pop();return a.obj.strokes.pop(),e.layer.undone.push(a),e.layer.redraw(),e},redo:function(e){var a=e.layer.undone.pop();return a.obj.strokes.push(a.stroke),e.layer.actions.push(a),e.layer.redraw(),e},select:function(e){var t=a.eraser;t.innerToolDiv=$("<div>").addClass("canvasPaintToolsInnerDiv"),a.scrollingToolDiv.append(t.innerToolDiv);var o=$("<div>").css("Order",1).addClass("canvasPaintToolOptionDiv");t.innerToolDiv.append(o),o.append($("<label>").html("Stroke Width: ")),t.strokeWidthSpan=$("<span>"),o.append(t.strokeWidthSpan).append("<br>"),t.strokeWidth=$("<input>").attr({type:"range",max:150,min:0,value:a.strokeWidth}).addClass("canvasPaintSlider"),o.append(t.strokeWidth),t.strokeWidth.on("input change",t.brushAdjusted),o.append("<br>"),o.append($("<label>").html("Stroke Opacity: ")),t.strokeOpacitySpan=$("<span>"),o.append(t.strokeOpacitySpan).append("%<br>"),t.strokeOpacity=$("<input>").attr({type:"range",max:100,min:0,value:100*a.strokeOpacity}).addClass("canvasPaintSlider"),o.append(t.strokeOpacity),t.strokeOpacity.on("input change",t.brushAdjusted),t.brushToolPreview=$("<canvas>").attr({height:150,width:150}).addClass("canvasPaintBrushPreview"),t.innerToolDiv.append($("<div>").addClass("canvasPaintToolOptionDiv canvasPaintCenter").css("order",3).append(t.brushToolPreview)),t.brushAdjusted(),t.icon.addClass("canvasPaintImgButtonSelected"),a.toolNameSpan.html("Eraser"),a.currTool=t},unselect:function(){var e=a.eraser;e.icon.removeClass("canvasPaintImgButtonSelected"),e.innerToolDiv.remove()},addIcon:function(e){var t=a.eraser;t.icon=$("<img>").css("order",e).attr({src:"resources/eraser.png",alt:"Eraser",title:"Eraser"}).addClass("canvasPaintImgButton").click({tool:t},a.setTool),a.drawingToolsGroup.append(t.icon)},brushAdjusted:function(e){var t=a.eraser;a.strokeWidth=t.strokeWidth.val(),a.strokeOpacity=t.strokeOpacity.val()/100,t.strokeWidthSpan.html(a.strokeWidth),t.strokeOpacitySpan.html(t.strokeOpacity.val());var o=t.brushToolPreview[0].getContext("2d");o.clearRect(0,0,o.canvas.width,o.canvas.height),o.fillStyle="#000000",o.globalAlpha=a.strokeOpacity,o.beginPath(),o.arc(o.canvas.width/2,o.canvas.height/2,a.strokeWidth/2,0,2*Math.PI),o.fill()},drawTool:function(){a.owner.mainContext.fillStyle="#000000",a.owner.mainContext.globalAlpha=a.strokeOpacity,a.owner.mainContext.beginPath(),a.owner.mainContext.arc(a.owner.mousePosition.x,a.owner.mousePosition.y,a.strokeWidth/2,0,2*Math.PI),a.owner.mainContext.fill()}},a.addLayer={doAction:function(e){var t=e.manager;t.layers.push(new t.layer),t.useLayer(t.layers[t.layers.length-1]),t.currLayer.actions.push({tool:"addLayer",layer:t.currLayer}),a.owner.AM.addToHistory({tool:"addLayer",layer:t.currLayer})},undo:function(e){var a=e.layer,t=(a.manager,a.actions.pop());a.miniLayerDiv.remove();var o,r=!1,n=a.manager.currLayer.id==a.id;for(o=0;o<a.manager.layers.length;o++)a.manager.layers[o].id==a.id&&(a.manager.layers.splice(o,1),r=!0,n&&(0!=o?a.manager.useLayer(a.manager.layers[o-1]):o<a.manager.layers.length?a.manager.useLayer(a.manager.layers[o]):a.manager.currLayer=void 0)),r&&o<a.manager.layers.length&&a.manager.layers[o].setOrder(o);return a.undone.push(t),e},redo:function(e){var a=e.layer,t=a.manager,o=a.undone.pop();a.manager.layers.splice(a.order,0,a),a.genHTML();for(var r=0;r<a.manager.layers.length;r++)a.manager.layers[r].setOrder(r);return o.wasCurr&&a.manager.useLayer(a),t.useLayer(a),a.redraw(),a.actions.push(o),e}},a.toggleLayerVisibility={doAction:function(e){lbase=e.layer,this.action(lbase),lbase.actions.push({tool:"toggleLayerVisibility",layer:lbase}),a.owner.AM.addToHistory({tool:"toggleLayerVisibility",layer:lbase})},undo:function(e){return lbase=e.layer,this.action(lbase),lbase.undone.push(lbase.actions.pop()),e},redo:function(e){return lbase=e.layer,this.action(lbase),lbase.actions.push(lbase.undone.pop()),e},action:function(e){e.show=!e.show,e.show?(e.visibilityToggleButton.attr("src","resources/openEye.png"),e.objects.forEach(function(e){e.show()})):(e.visibilityToggleButton.attr("src","resources/closedEye.png"),e.objects.forEach(function(e){e.hide()}))}},a.clear={doAction:function(e){e.layer.actions.push({tool:"clear",objects:e.layer.objects.slice(),erased:e.layer.erased.slice()}),e.layer.objects.forEach(function(e){e.delCanvas()}),e.layer.objects=[],e.layer.erased=[],a.owner.AM.addToHistory({tool:"clear",layer:e.layer}),e.layer.redraw()},undo:function(e){var a=e.layer.actions.pop();return e.layer.objects=a.objects,e.layer.erased=a.erased,e.layer.objects.forEach(function(e){e.genCanvas()}),e.layer.undone.push({tool:"clear"}),e.layer.redraw(),{tool:"clear",layer:e.layer}},redo:function(e){e.layer.undone.pop();return e.layer.actions.push({tool:"clear",objects:e.layer.objects.slice(),erased:e.layer.erased.slice()}),e.layer.objects.forEach(function(e){e.delCanvas()}),e.layer.objects=[],e.layer.redraw(),{tool:"clear",layer:e.layer}}},a.deleteLayer={doAction:function(e){e.layer.miniLayerDiv.remove();for(var t=!1,o=e.layer.manager.currLayer.id==e.layer.id,r=0;r<e.layer.manager.layers.length;r++)e.layer.manager.layers[r].id==e.layer.id&&(e.layer.manager.layers.splice(r,1),t=!0,o&&(0!=r?e.layer.manager.useLayer(e.layer.manager.layers[r-1]):r<e.layer.manager.layers.length?e.layer.manager.useLayer(e.layer.manager.layers[r]):e.layer.manager.currLayer=void 0)),t&&r<e.layer.manager.layers.length&&e.layer.manager.layers[r].setOrder(r);e.layer.objects.forEach(function(e){e.delCanvas()}),e.layer.actions.push({tool:"deleteLayer",layer:e.layer,wasCurr:o}),a.owner.AM.addToHistory({tool:"deleteLayer",layer:e.layer})},undo:function(e){var a=e.layer.actions.pop();a.layer.manager.layers.splice(a.layer.order,0,a.layer),a.layer.genHTML(),a.layer.objects.forEach(function(e){e.genCanvas()}),a.layer.undone.push(a);for(var t=0;t<a.layer.manager.layers.length;t++)a.layer.manager.layers[t].setOrder(t);return a.wasCurr&&a.layer.manager.useLayer(a.layer),a.layer.redraw(),e},redo:function(e){var a=e.layer.undone.pop();a.layer.miniLayerDiv.remove();var t,o=!1,r=a.layer.manager.currLayer.id==a.layer.id;for(t=0;t<a.layer.manager.layers.length;t++)a.layer.manager.layers[t].id==a.layer.id&&(a.layer.manager.layers.splice(t,1),o=!0,r&&(0!=t?a.layer.manager.useLayer(a.layer.manager.layers[t-1]):t<a.layer.manager.layers.length?a.layer.manager.useLayer(a.layer.manager.layers[t]):a.layer.manager.currLayer=void 0)),o&&t<a.layer.manager.layers.length&&a.layer.manager.layers[t].setOrder(t);return a.layer.objects.forEach(function(e){e.delCanvas()}),a.layer.actions.push(a),e}},a.moveLayerUp={doAction:function(e){for(var t=e.layer,o=t.manager,r=0;r<o.layers.length;r++)if(o.layers[r].id==t.id&&r<o.layers.length-1)return o.layers[r]=o.layers[r+1],o.layers[r+1]=t,t.setOrder(r+1),o.layers[r].setOrder(r),t.actions.push({tool:"moveLayerUp",layer:t}),void a.owner.AM.addToHistory({tool:"moveLayerUp",layer:t})},undo:function(e){for(var a=e.layer,t=a.manager,o=a.actions.pop(),r=0;r<t.layers.length;r++)if(t.layers[r].id==a.id&&r>0)return t.layers[r]=t.layers[r-1],t.layers[r-1]=a,a.setOrder(r-1),t.layers[r].setOrder(r),a.undone.push(o),e},redo:function(e){for(var a=e.layer,t=a.manager,o=a.undone.pop(),r=0;r<t.layers.length;r++)if(t.layers[r].id==a.id&&r<t.layers.length-1)return t.layers[r]=t.layers[r+1],t.layers[r+1]=a,a.setOrder(r+1),t.layers[r].setOrder(r),a.actions.push(o),e}},a.moveLayerDown={doAction:function(e){for(var t=e.layer,o=t.manager,r=0;r<o.layers.length;r++)if(o.layers[r].id==t.id&&r>0)return o.layers[r]=o.layers[r-1],o.layers[r-1]=t,t.setOrder(r-1),o.layers[r].setOrder(r),t.actions.push({tool:"moveLayerDown",layer:t}),void a.owner.AM.addToHistory({tool:"moveLayerDown",layer:t})},undo:function(e){for(var a=e.layer,t=a.manager,o=a.undone.pop(),r=0;r<t.layers.length;r++)if(t.layers[r].id==a.id&&r<t.layers.length-1)return t.layers[r]=t.layers[r+1],t.layers[r+1]=a,a.setOrder(r+1),t.layers[r].setOrder(r),a.actions.push(o),e},redo:function(e){for(var a=e.layer,t=a.manager,o=a.undone.pop(),r=0;r<t.layers.length;r++)if(t.layers[r].id==a.id&&r>0)return t.layers[r]=t.layers[r-1],t.layers[r-1]=a,a.setOrder(r-1),t.layers[r].setOrder(r),a.actions.push(o),e}},a.changeLayerOpacity={doAction:function(e){var t=e.layer,o=t.opacitySlider.val()/100,r=t.actions[t.actions.length-1];e.dragging?r&&"changeLayerOpacity"==r.tool&&r.dragging?r.valueTo=o:(t.actions.push({tool:"changeLayerOpacity",dragging:!0,valueTo:o,valueFrom:t.opacity}),a.owner.AM.addToHistory({tool:"changeLayerOpacity",layer:t})):"changeLayerOpacity"==r.tool&&r.dragging?(r.valueTo=o,r.dragging=!1):(t.actions.push({tool:"changeLayerOpacity",dragging:!1,valueTo:o,valueFrom:t.opacity}),a.owner.AM.addToHistory({tool:"changeLayerOpacity",layer:t})),t.opacity=o,t.opacitySpan.html(t.opacitySlider.val()),t.redraw()},undo:function(e){var a=e.layer,t=a.actions.pop();return console.log(t),a.opacity=t.valueFrom,a.opacitySpan.html(Math.round(100*t.valueFrom)),a.opacitySlider.val(100*t.valueFrom),a.undone.push(t),a.redraw(),e},redo:function(e){var a=e.layer,t=a.undone.pop();return console.log(t),a.opacity=t.valueTo,a.opacitySpan.html(Math.round(100*t.valueTo)),a.opacitySlider.val(100*t.valueTo),a.actions.push(t),a.redraw(),e}},a["export"]={addIcon:function(e){var t=a["export"];a.exportToolGroup.append($("<label>").html("Export as:")),t.exportFilename=$("<input>").attr({type:"text",placeholder:"drawing"}).addClass("canvasPaintExportFilename"),a.exportToolGroup.append(t.exportFilename),a.exportToolGroup.append(".png"),t.exportButton=$("<span>").html("Export").addClass("canvasPaintImgButton").click(t.exportDrawing),a.exportToolGroup.append(t.exportButton)},exportDrawing:function(e){var t=a["export"],o=a.owner;o.mainContext.clearRect(0,0,o.mainContext.canvas.width,o.mainContext.canvas.height),o.mainContext.globalAlpha=1,o.LM.layers.forEach(function(e){e.drawOnGlobal()}),o.mainCanvas[0].toBlobHD(function(e){saveAs(e,(t.exportFilename.val()||t.exportFilename.attr("placeholder"))+".png")},"image/png"),o.mainContext.clearRect(0,0,o.mainContext.canvas.width,o.mainContext.canvas.height)}},a.history={addIcon:function(e){var t=a.history;a.historyToolGroup.append($("<img>").css("order",0).addClass("canvasPaintImgButton").attr({src:"resources/undo.png",alt:"Undo",title:"Undo"}).click(t.undo)).append($("<img>").css("order",1).addClass("canvasPaintImgButton").attr({src:"resources/redo.png",alt:"Redo",title:"Redo"}).click(t.redo)),$("body").keydown(t.keyDown)},undo:function(e){a.owner.AM.undo()},redo:function(e){a.owner.AM.redo()},keyDown:function(e){e=e||window.event;var t=a.history;90!=e.which&&90!=e.keyCode||!e.ctrlKey?89!=e.which&&89!=e.keyCode||!e.ctrlKey||t.redo():t.undo()}}}!function(e,a,t){e.boglePlugin||(e.boglePlugin={});var o=e("<link>");e("head").append(o),o.attr({rel:"stylesheet",type:"text/css",href:"resources/canvasPaint.css"}),e.boglePlugin.drawing=function(a,t,o){var r=this;r.$el=e(a),r.el=a,r.$el.data("boglePlugin.drawing",r),r.init=function(){r.functionParam=t,r.options=e.extend({},e.boglePlugin.drawing.defaultOptions,o),r.mousePosition={},r.AM=new CanvasPaintActionManager(r),r.TM=new CanvasPaintToolManager(r),r.OF=new CanvasPaintObjectFactory(r),r.LM=new CanvasPaintLayerManager(r);var a=e("<section>").addClass("canvasPaintMain");r.$el.append(a),r.topSect=e("<section>").addClass("canvasPaintTopSect"),a.append(r.topSect);var n=e("<section>").addClass("canvasPaintMiddleSect");a.append(n);var s=e("<div>").addClass("canvasPaintLayersOuterDiv").css("order",0);n.append(s),s.append(e("<strong>").html("Layers ")),r.addNewLayerButton=e("<img>").attr({src:"resources/add.png",alt:"Add New Layer",title:"Add New Layer"}).addClass("canvasPaintImgButton"),s.append(r.addNewLayerButton),r.addNewLayerButton.click(r.addNewLayer);var i=e("<div>").addClass("canvasPaintLayersScrollingDiv");s.append(i),r.layersInnerDiv=e("<div>").addClass("canvasPaintLayersInnerDiv"),i.append(r.layersInnerDiv),r.canvasDiv=e("<div>").addClass("canvasPaintMainCanvasDiv").css("order",1),r.canvasScrollingDiv=e("<div>").addClass("canvasPaintMainCanvasScrollingDiv"),r.canvasInnerDiv=e("<div>").addClass("canvasPaintMainCanvasInnerDiv"),r.canvasDiv.append(r.canvasScrollingDiv.append(r.canvasInnerDiv)),n.append(r.canvasDiv),r.mainCanvas=e("<canvas>").attr({height:r.options.canvHeight,width:r.options.canvWidth}).addClass("canvasPaintMainCanvas"),r.canvasInnerDiv.append(r.mainCanvas),r.mainContext=r.mainCanvas[0].getContext("2d"),r.mainCanvas.on("mousedown mousemove touchstart touchmove",r.canvasMouseDownMove),r.mainCanvas.on("mouseup mouseleave touchend",r.canvasMouseUpLeave),r.mainCanvas.on("contextmenu",r.canvasContextMenu),r.outerToolDiv=e("<div>").addClass("canvasPaintToolsOuterDiv").css("order",2),n.append(r.outerToolDiv),r.LM.blankData=r.mainCanvas[0].toDataURL(),e("body").keydown(r.keyDown),r.addNewLayer(),r.TM.setUpTools(),r.AM.history.pop(),r.LM.layers[0].actions.pop(),console.log("Canvas Paint: Ready to draw!")},r.addNewLayer=function(){r.LM.addNewLayer()},r.undo=function(e){r.AM.undo()},r.redo=function(e){r.AM.redo()},r.getMousePosition=function(e){if("mouseleave"==e.type)return void(r.mousePosition.offCanvas=!0);r.mousePosition.offCanvas=!1;var a=r.mainCanvas[0].getBoundingClientRect();"touchstart"==e.type||"touchmove"==e.type?(r.mousePosition.x=e.originalEvent.changedTouches[0].clientX-a.left,r.mousePosition.y=e.originalEvent.changedTouches[0].clientY-a.top):(r.mousePosition.x=e.clientX-a.left,r.mousePosition.y=e.clientY-a.top)},r.canvasMouseDownMove=function(e){if(e.preventDefault(),r.getMousePosition(e),!(e.which>1)){var a;"mousedown"==e.type||"touchstart"==e.type?(a=!1,r.LM.currLayer.canvasPaint=!0):("mousemove"==e.type||"touchmove"==e.type)&&(a=!0);var t={layer:r.LM.currLayer,mX:r.mousePosition.x,mY:r.mousePosition.y,dragging:a};r.LM.currLayer.canvasPaint&&r.TM.currTool.doAction(t),r.redrawBrush()}},r.canvasMouseUpLeave=function(e){r.LM.currLayer.canvasPaint&&e.which<=1&&(r.LM.currLayer.canvasPaint=!1),r.getMousePosition(e),r.redrawBrush()},this.canvasContextMenu=function(e){e.preventDefault()},r.drawBrush=function(){r.mousePosition.offCanvas||r.TM.currTool.drawTool()},r.redrawBrush=function(){r.mainContext.clearRect(0,0,r.mainContext.canvas.width,r.mainContext.canvas.height),r.drawBrush()},r.init()},e.boglePlugin.drawing.defaultOptions={canvWidth:700,canvHeight:394,currTool:"paint",strokeColor:"#ff0000",strokeWidth:20,strokeOpacity:100},e.fn.boglePlugin_drawing=function(a,t){return this.each(function(){new e.boglePlugin.drawing(this,a,t)})},e(a).ready(function(){e(".canvasPaint").boglePlugin_drawing()})}(jQuery);