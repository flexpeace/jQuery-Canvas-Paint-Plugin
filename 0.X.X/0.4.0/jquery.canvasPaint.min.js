// canvasPaint Plugin: 0.2.0
function CanvasPaintObjectFactory(e){var t=this;t.owner=e,t.drawingObject=function(e,t){return t.tool=e.tool,t.id=e.id,t.order=e.order,t.layer=e.layer,t.erased=[],t.genCanvas=function(){t.bigCanvas=$("<canvas>").attr({height:t.layer.manager.owner.options.canvHeight,width:t.layer.manager.owner.options.canvWidth}).addClass("canvasPaintObjectCanvas").css("z-index",1e3*t.layer.order+t.order),t.layer.manager.owner.canvasDiv.append(t.bigCanvas),t.bigContext=t.bigCanvas[0].getContext("2d")},t.genCanvas(),t.delCanvas=function(){this.bigCanvas.remove(),delete this.bigContext},t.drawOnContextAsImg=function(e){this.draw(),e.drawImage(this.bigCanvas[0],0,0)},t.show=function(){this.bigCanvas.show()},t.hide=function(){this.bigCanvas.hide()},t.setOrder=function(e){this.order=e,this.bigCanvas.css("z-index",1e3*this.layer.order+e)},t.setLayerOrder=function(){this.setOrder(this.order)},t.computeVisualBounds=function(){var e,t,a,o=this.bounds.points,n=this.bounds.visual,r=this.bigContext.getImageData(o.left,o.top,o.right-o.left,o.bottom-o.top),i=r.height,s=r.width,l=r.data;for(a=!1,e=0;s>e&&!a;e++)for(t=0;i>t&&!a;t++)l[4*(t*s+e)+3]>0&&(n.left=e+o.left,a=!0);for(a=!1,t=0;i>t&&!a;t++)for(e=0;s>e&&!a;e++)l[4*(t*s+e)+3]>0&&(n.top=t+o.top,a=!0);for(a=!1,e=s-1;e>0&&!a;e--)for(t=0;i>t&&!a;t++)l[4*(t*s+e)+3]>0&&(n.right=e+o.left,a=!0);for(a=!1,t=i-1;t>0&&!a;t--)for(e=0;s>e&&!a;e++)l[4*(t*s+e)+3]>0&&(n.bottom=t+o.top,a=!0)},t.drawPointsBoundingBox=function(){this.bigContext.setLineDash([6]),this.bigContext.lineWidth=4,this.bigContext.strokeStyle="#000000",this.bigContext.beginPath(),this.bigContext.globalCompositeOperation="source-over",this.bigContext.rect(this.bounds.points.left,this.bounds.points.top,this.bounds.points.right-this.bounds.points.left,this.bounds.points.bottom-this.bounds.points.top),this.bigContext.stroke(),this.bigContext.setLineDash([0])},t.drawVisualBoundingBox=function(){this.bigContext.setLineDash([6]),this.bigContext.lineWidth=4,this.bigContext.strokeStyle="#000000",this.bigContext.beginPath(),this.bigContext.globalCompositeOperation="source-over",this.bigContext.rect(this.bounds.visual.left,this.bounds.visual.top,this.bounds.visual.right-this.bounds.visual.left,this.bounds.visual.bottom-this.bounds.visual.top),this.bigContext.stroke(),this.bigContext.setLineDash([0])},this},t.paintObject=function(e){return t.drawingObject(e,this),this.type="paint",this.strokes=[],this.strokes.push({points:[{x:e.mX,y:e.mY}],tool:e.tool,strokeColor:t.owner.TM.strokeColor,strokeWidth:t.owner.TM.strokeWidth,strokeOpacity:t.owner.TM.strokeOpacity,bounds:{left:e.mX-t.owner.TM.strokeWidth/2,top:e.mY-t.owner.TM.strokeWidth/2,right:e.mX+t.owner.TM.strokeWidth/2,bottom:e.mY+t.owner.TM.strokeWidth/2}}),this.bounds={points:{},visual:{}},this.bounds.points.left=e.mX-this.strokes[0].strokeWidth/2,this.bounds.points.top=e.mY-this.strokes[0].strokeWidth/2,this.bounds.points.right=e.mX+this.strokes[0].strokeWidth/2,this.bounds.points.bottom=e.mY+this.strokes[0].strokeWidth/2,this.bounds.visual.left=e.mX-this.strokes[0].strokeWidth/2,this.bounds.visual.top=e.mY-this.strokes[0].strokeWidth/2,this.bounds.visual.right=e.mX+this.strokes[0].strokeWidth/2,this.bounds.visual.bottom=e.mY+this.strokes[0].strokeWidth/2,this.addPoint=function(e){if(e.dragging){var a=this.strokes[this.strokes.length-1];a.points.push({x:e.mX,y:e.mY});var o=a.strokeWidth/2;e.mX-o<a.bounds.left&&(a.bounds.left=e.mX-o),e.mY-o<a.bounds.top&&(a.bounds.top=e.mY-o),e.mX+o>a.bounds.right&&(a.bounds.right=e.mX+o),e.mY+o>a.bounds.bottom&&(a.bounds.bottom=e.mY+o)}else this.isBlank=!1,this.strokes.push({points:[{x:e.mX,y:e.mY}],tool:e.tool,strokeColor:t.owner.TM.strokeColor,strokeWidth:t.owner.TM.strokeWidth,strokeOpacity:t.owner.TM.strokeOpacity,bounds:{left:e.mX-t.owner.TM.strokeWidth/2,top:e.mY-t.owner.TM.strokeWidth/2,right:e.mX+t.owner.TM.strokeWidth/2,bottom:e.mY+t.owner.TM.strokeWidth/2}});return this.strokes[this.strokes.length-1]},this.addErasePoint=function(e){return this.addPoint(e)},this.undoErase=function(){this.strokes.pop(),this.isBlank=!1},this.redoErase=function(e){this.strokes.push(e)},this.draw=function(){if(!this.isBlank){this.bigContext.clearRect(0,0,this.bigContext.canvas.width,this.bigContext.canvas.height),this.bigContext.lineJoin="round",this.bigContext.lineCap="round";for(var e=0;e<this.strokes.length;e++){this.bigContext.beginPath(),this.bigContext.strokeStyle=this.strokes[e].strokeColor,this.bigContext.globalAlpha=this.strokes[e].strokeOpacity*this.layer.opacity,this.bigContext.lineWidth=this.strokes[e].strokeWidth,"paint"==this.strokes[e].tool?this.bigContext.globalCompositeOperation="source-over":"eraser"==this.strokes[e].tool&&(this.bigContext.globalCompositeOperation="destination-out");for(var a=0;a<this.strokes[e].points.length;a++)0==a&&(this.bigContext.moveTo(this.strokes[e].points[a].x,this.strokes[e].points[a].y),this.bigContext.lineTo(this.strokes[e].points[a].x+.001,this.strokes[e].points[a].y)),this.bigContext.lineTo(this.strokes[e].points[a].x,this.strokes[e].points[a].y);this.bigContext.stroke()}this.layer.previewContext.drawImage(this.bigCanvas[0],0,0),this.bigCanvas[0].toDataURL()==t.owner.LM.blankData&&(this.isBlank=!0)}},this.computePointsBounds=function(){var e=(this.bigContext,this.bounds.points);e.left=void 0,e.top=void 0,e.right=void 0,e.bottom=void 0,this.strokes.forEach(function(t){"paint"==t.tool&&((!e.left||t.bounds.left<e.left)&&(e.left=t.bounds.left),(!e.top||t.bounds.top<e.top)&&(e.top=t.bounds.top),(!e.right||t.bounds.right>e.right)&&(e.right=t.bounds.right),(!e.bottom||t.bounds.bottom>e.bottom)&&(e.bottom=t.bounds.bottom))})},this},t.rectangleObject=function(e){return t.drawingObject(e,this),this.type="rectangle",this.fillColor=t.owner.TM.fillColor,this.fillOpacity=t.owner.TM.fillOpacity,this.outlineColor=t.owner.TM.outlineColor,this.outlineColor=t.owner.TM.outlineColor,this.outlineWidth=t.owner.TM.outlineWidth,this.outlineOpacity=t.owner.TM.outlineOpacity,this.points={p1:{x:e.mX,y:e.mY},p2:{x:e.mX,y:e.mY},topLeft:{x:e.mX,y:e.mY},height:1e-5,width:1e-5},this.bounds={points:{},visual:{}},this.erased={strokes:[]},this.updateRectangle=function(e){this.isBlank=!1,this.points.p2.x=e.mX,this.points.p2.y=e.mY,this.points.topLeft.x=Math.min(this.points.p1.x,this.points.p2.x),this.points.topLeft.y=Math.min(this.points.p1.y,this.points.p2.y),this.points.width=Math.max(this.points.p1.x,this.points.p2.x)-this.points.topLeft.x,this.points.height=Math.max(this.points.p1.y,this.points.p2.y)-this.points.topLeft.y},this.addErasePoint=function(e){if(e.dragging){var a=this.erased.strokes[this.erased.strokes.length-1];a.points.push({x:e.mX,y:e.mY})}else this.erased.strokes.push({points:[{x:e.mX,y:e.mY}],strokeWidth:t.owner.TM.strokeWidth,strokeOpacity:t.owner.TM.strokeOpacity});return this.erased.strokes[this.erased.strokes.length-1]},this.undoErase=function(){this.erased.strokes.pop(),this.isBlank=!1},this.redoErase=function(e){this.erased.strokes.push(e)},this.draw=function(){if(!this.isBlank){var e=this.bigContext;e.clearRect(0,0,this.bigContext.canvas.width,this.bigContext.canvas.height);var a=parseInt(this.outlineWidth);e.globalCompositeOperation="source-over",e.fillStyle=this.fillColor,e.globalAlpha=this.fillOpacity*this.layer.opacity,a*this.outlineOpacity>0?(e.fillRect(this.points.topLeft.x+a,this.points.topLeft.y+a,this.points.width-2*a,this.points.height-2*a),e.strokeStyle=this.outlineColor,e.lineWidth=a,e.globalAlpha=this.outlineOpacity*this.layer.opacity,e.lineJoin="miter",e.lineCap="butt",e.strokeRect(this.points.topLeft.x+a/2,this.points.topLeft.y+a/2,this.points.width-a,this.points.height-a)):e.fillRect(this.points.topLeft.x,this.points.topLeft.y,this.points.width,this.points.height),e.globalCompositeOperation="destination-out",this.erased.strokes.forEach(function(t){e.beginPath(),e.lineWidth=t.strokeWidth,e.globalAlpha=t.strokeOpacity,e.lineJoin="round",e.lineCap="round";for(var a=0;a<t.points.length;a++)0==a&&(e.moveTo(t.points[a].x,t.points[a].y),e.lineTo(t.points[a].x+.001,t.points[a].y)),e.lineTo(t.points[a].x,t.points[a].y);e.stroke()}),this.layer.previewContext.drawImage(this.bigCanvas[0],0,0),this.bigCanvas[0].toDataURL()==t.owner.LM.blankData&&(this.isBlank=!0)}},this.computePointsBounds=function(){var e=(this.bigContext,this.bounds.points);e.left=this.points.topLeft.x,e.top=this.points.topLeft.y,e.right=this.points.topLeft.x+this.points.topLeft.width,e.bottom=this.points.topLeft.y+this.points.topLeft.height},this}}function CanvasPaintLayerManager(e){var t=this;t.owner=e,t.layers=[],t.blankData,t.addNewLayer=function(e){return t.owner.TM.addLayer.doAction({manager:t,order:e}),t.currLayer},t.useLayer=function(e){t.currLayer&&t.currLayer.dontUse(),Number.isInteger(e)?t.getLayer(e).use():e.use()},t.useLayerClicked=function(e){t.useLayer(e.data.layer)},t.getLayer=function(e){t.layers.forEach(function(t){return e==t.id?t:void 0})},t.layer=function(){var e=this;e.manager=t,e.id=0,e.order=0,e.opacity=1,e.erased=[],t.layers.forEach(function(t){e.id=Math.max(e.id,t.id),e.order=Math.max(e.order,t.order)}),t.layers.length&&(e.id+=1,e.order+=1),e.show=!0,e.canvasPaint=!1,e.currObj=void 0,e.genHTML=function(){e.miniLayerDiv=$("<div>").addClass("canvasPaintMiniLayerDiv").css("order",e.order).click({layer:e},t.useLayerClicked),t.owner.layersInnerDiv.append(e.miniLayerDiv),e.miniLayerDiv.append($("<strong>").html("Layer id: "+e.id));var a=$("<div>").addClass("canvasPaintLayerToolbar");e.miniLayerDiv.append(a),e.visibilityToggleButton=$("<img>").attr({src:"resources/openEye.png",alt:"Hide Layer",title:"Hide Layer"}).addClass("canvasPaintImgButton").click(e.toggleShow),a.append($("<div>").addClass("canvasPaintVisibilityToggleDiv").css("order",0).append(e.visibilityToggleButton)),a.append($("<span>").html("Clear").addClass("canvasPaintImgButton").css("order",1).click({layer:this},e.clear)),a.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",2).append($("<img>").attr({src:"resources/delete.png",alt:"Delete Layer",title:"Delete Layer"}).addClass("canvasPaintImgButton").click({layer:this},e.deleteLayer))),a.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",3).append($("<img>").attr({src:"resources/up.png",alt:"Move Layer Up",title:"Move Layer Up"}).addClass("canvasPaintImgButton").click({layer:this},e.moveUp))),a.append($("<div>").addClass("canvasPaintImgButtonDiv").css("order",4).append($("<img>").attr({src:"resources/down.png",alt:"Move Layer Down",title:"Move Layer Down"}).addClass("canvasPaintImgButton").click({layer:this},e.moveDown))),e.opacitySpan=$("<span>").html("100").addClass("canvasPaintValueSpan"),e.opacitySlider=$("<input>").attr({type:"range",min:0,max:100,value:100}).addClass("canvasPaintLayerOpacity").on("input change",e.opacityChange),a.append($("<div>").html("Layer Opacity: ").addClass("canvasPaintInputDiv").css("order",5).append(e.opacitySpan).append("%").append(e.opacitySlider)),e.previewCanvas=$("<canvas>").attr({height:t.owner.mainContext.canvas.height,width:t.owner.mainContext.canvas.width}).addClass("canvasPaintLayerPreviewCanvas"),e.miniLayerDiv.append(e.previewCanvas),e.previewContext=e.previewCanvas[0].getContext("2d")},e.actions=[],e.undone=[],e.objects=[],e.use=function(){e.miniLayerDiv.addClass("canvasPaintLelectedLayer"),t.currLayer=e},e.dontUse=function(){e.miniLayerDiv.removeClass("canvasPaintLelectedLayer")},e.clear=function(a){t.owner.TM.clear.doAction({layer:e})},e.deleteLayer=function(a){t.owner.TM.deleteLayer.doAction({layer:e})},e.moveUp=function(a){t.owner.TM.moveLayerUp.doAction({layer:e})},e.moveDown=function(a){t.owner.TM.moveLayerDown.doAction({layer:e})},e.opacityChange=function(a){var o=!0;"change"==a.type&&(o=!1),t.owner.TM.changeLayerOpacity.doAction({layer:e,dragging:o})},e.getObj=function(t){var a;for(a=0;a<e.objects.length;a++)if(e.objects[a].id==t)return e.objects[a]},e.redraw=function(){e.previewContext.clearRect(0,0,e.previewContext.canvas.width,e.previewContext.canvas.height),e.show&&e.objects.forEach(function(e){e.draw()})},e.drawOnGlobal=function(){e.show&&e.objects.forEach(function(e){e.drawOnContextAsImg(t.owner.mainContext)})},e.setOrder=function(t){e.order=t,e.miniLayerDiv.css("order",t),e.objects.forEach(function(e){e.setLayerOrder(t)})},e.toggleShow=function(){t.owner.TM.toggleLayerVisibility.doAction({layer:e})},e.genHTML()}}function CanvasPaintActionManager(e){this.owner=e,this.history=new Array,this.future=new Array,this.historyLimit=100,this.addToHistory=function(e){if(this.history.push(e),this.future.length>0&&(this.future.forEach(function(e){e.layer.undone=[]}),this.future=[]),this.history.length>this.historyLimit){var t=this.history.shift();t.layer.actions.shift()}},this.undo=function(){if(this.history.length>0){var e=this.history.pop();this.future.push(this.owner.TM.getTool(e.tool).undo(e))}},this.redo=function(){if(this.future.length>0){var e=this.future.pop();this.history.push(this.owner.TM.getTool(e.tool).redo(e))}}}function CanvasPaintToolManager(e){var t=this;t.owner=e,t.currTool,t.strokeColor=t.owner.options.strokeColor,t.strokeWidth=t.owner.options.strokeWidth,t.strokeOpacity=t.owner.options.strokeOpacity/100,t.fillColor=t.owner.options.fillColor,t.fillOpacity=t.owner.options.fillOpacity,t.outlineColor=t.owner.options.outlineColor,t.outlineWidth=t.owner.options.outlineWidth,t.outlineOpacity=t.owner.options.outlineOpacity/100,t.setTool=function(e){t.currTool&&t.currTool.unselect(),e.data.tool.select()},t.getTool=function(e){switch(e){case"paint":return t.paint;case"eraser":return t.eraser;case"rectangle":return t.rectangle;case"clear":return t.clear;case"addLayer":return t.addLayer;case"toggleLayerVisibility":return t.toggleLayerVisibility;case"deleteLayer":return t.deleteLayer;case"moveLayerUp":return t.moveLayerUp;case"moveLayerDown":return t.moveLayerDown;case"changeLayerOpacity":return t.changeLayerOpacity}},t.setUpTools=function(){t.toolNameSpan=$("<span>"),t.owner.outerToolDiv.append(t.toolNameSpan).append(" Settings"),t.scrollingToolDiv=$("<div>").addClass("canvasPaintToolsScrollingDiv"),t.owner.outerToolDiv.append(t.scrollingToolDiv),t.addTopToolBar(),t.addExportTools(0),t.addHistoryTools(1),t.addDrawingIcons(2),t.setTool({data:{tool:t.getTool(t.owner.options.currTool)}})},t.addTopToolBar=function(){t.topToolbar=$("<div>").addClass("canvasPaintTopToolbar"),t.owner.topSect.append(t.topToolbar)},t.addExportTools=function(e){t.exportToolGroup=$("<div>").addClass("canvasPaintToolGroup").css("order",e),t.topToolbar.append(t.exportToolGroup),t["export"].addIcon(0)},t.addHistoryTools=function(e){t.historyToolGroup=$("<div>").addClass("canvasPaintToolGroup").css("order",e),t.topToolbar.append(t.historyToolGroup),t.history.addIcon(0)},t.addDrawingIcons=function(e){t.drawingToolsGroup=$("<div>").addClass("canvasPaintToolGroup").css("order",e),t.topToolbar.append(t.drawingToolsGroup),t.paint.addIcon(0),t.eraser.addIcon(1),t.rectangle.addIcon(2)},t.paint={doAction:function(e){var a=e.layer;if(a.show&&(0!=a.objects.length&&!e.dragging&&a.type&&"paint"!=a.type&&(a.canvasPaint=!1,t.owner.LM.addNewLayer(a.order+1),e.layer=t.owner.LM.currLayer,a=t.owner.LM.currLayer,a.canvasPaint=!0),e.tool="paint",0==a.objects.length?(e.order=0,a.type="paint",a.objects.push(new t.owner.OF.paintObject(e)),a.currObj=a.objects[0]):a.currObj.addPoint(e),a.redraw(),!e.dragging)){var o={tool:"paint",layer:e.layer,obj:a.currObj,stroke:a.currObj.strokes[a.currObj.strokes.length-1]};a.actions.push(o),t.owner.AM.addToHistory({tool:"paint",layer:e.layer})}},undo:function(e){var t=e.layer.actions.pop();return 1==t.obj.strokes.length?(t.obj.delCanvas(),t.layer.type=void 0,t.layer.objects.pop()):t.obj.strokes.pop(),e.layer.undone.push(t),e.layer.redraw(),e},redo:function(e){var t=e.layer.undone.pop();return t.stroke==t.obj.strokes[0]?(t.layer.objects.push(t.obj),t.obj.genCanvas(),t.layer.type="paint"):t.obj.strokes.push(t.stroke),e.layer.actions.push(t),e.layer.redraw(),e},select:function(e){var a=t.paint;a.innerToolDiv=$("<div>").addClass("canvasPaintToolsInnerDiv"),t.scrollingToolDiv.append(a.innerToolDiv);var o=$("<div>").addClass("canvasPaintToolOptionDiv").css("order",0);a.innerToolDiv.append(o.append($("<label>").html("Stroke Color: "))),a.strokeColor=$("<input>").attr({type:"color",value:t.strokeColor}).addClass("canvasPaintStrokeOption").on("input change",a.brushAdjusted),o.append(a.strokeColor);var n=$("<div>").css("Order",1).addClass("canvasPaintToolOptionDiv");a.innerToolDiv.append(n),n.append($("<label>").html("Stroke Width: ")),a.strokeWidthSpan=$("<span>"),n.append(a.strokeWidthSpan).append("<br>"),a.strokeWidth=$("<input>").attr({type:"range",max:150,min:0,value:t.strokeWidth}).addClass("canvasPaintSlider"),n.append(a.strokeWidth),a.strokeWidth.on("input change",a.brushAdjusted),n.append("<br>"),n.append($("<label>").html("Stroke Opacity: ")),a.strokeOpacitySpan=$("<span>"),n.append(a.strokeOpacitySpan).append("%<br>"),a.strokeOpacity=$("<input>").attr({type:"range",max:100,min:0,value:100*t.strokeOpacity}).addClass("canvasPaintSlider"),n.append(a.strokeOpacity),a.strokeOpacity.on("input change",a.brushAdjusted),a.brushToolPreview=$("<canvas>").attr({height:150,width:150}).addClass("canvasPaintBrushPreview"),a.innerToolDiv.append($("<div>").addClass("canvasPaintToolOptionDiv canvasPaintCenter").css("order",3).append(a.brushToolPreview)),a.brushAdjusted(),a.icon.addClass("canvasPaintImgButtonSelected"),t.toolNameSpan.html("Paint Brush"),t.currTool=a},unselect:function(){var e=t.paint;e.icon.removeClass("canvasPaintImgButtonSelected"),e.innerToolDiv.remove()},addIcon:function(e){pbase=t.paint,pbase.icon=$("<img>").css("order",e).attr({src:"resources/brush.png",alt:"Paint Brush",title:"Paint Brush"}).addClass("canvasPaintImgButton").click({tool:pbase},t.setTool),t.drawingToolsGroup.append(pbase.icon)},brushAdjusted:function(e){var a=t.paint;t.strokeColor=a.strokeColor.val(),t.strokeWidth=a.strokeWidth.val(),t.strokeOpacity=a.strokeOpacity.val()/100,a.strokeWidthSpan.html(t.strokeWidth),a.strokeOpacitySpan.html(a.strokeOpacity.val());var o=a.brushToolPreview[0].getContext("2d");o.clearRect(0,0,o.canvas.width,o.canvas.height),o.fillStyle=t.strokeColor,o.globalAlpha=t.strokeOpacity,o.beginPath(),o.arc(o.canvas.width/2,o.canvas.height/2,t.strokeWidth/2,0,2*Math.PI),o.fill()},drawTool:function(){t.owner.mainContext.fillStyle=t.strokeColor,t.owner.mainContext.globalAlpha=t.strokeOpacity,t.owner.mainContext.beginPath(),t.owner.mainContext.arc(t.owner.mousePosition.x,t.owner.mousePosition.y,t.strokeWidth/2,0,2*Math.PI),t.owner.mainContext.fill()}},t.eraser={doAction:function(e){var a=(t.eraser,e.layer);if(a.show&&0!=a.objects.length){e.tool="eraser";var o=a.currObj.addErasePoint(e);if(a.redraw(),!e.dragging){var n={tool:"eraser",layer:e.layer,obj:a.currObj,stroke:o};a.actions.push(n),t.owner.AM.addToHistory({tool:"eraser",layer:e.layer})}}},undo:function(e){var t=e.layer.actions.pop();return t.obj.undoErase(),t.obj.isBlank=!1,e.layer.undone.push(t),e.layer.redraw(),e},redo:function(e){var t=e.layer.undone.pop();return t.obj.redoErase(t.stroke),e.layer.actions.push(t),e.layer.redraw(),e},select:function(e){var a=t.eraser;a.innerToolDiv=$("<div>").addClass("canvasPaintToolsInnerDiv"),t.scrollingToolDiv.append(a.innerToolDiv);var o=$("<div>").css("Order",1).addClass("canvasPaintToolOptionDiv");a.innerToolDiv.append(o),o.append($("<label>").html("Stroke Width: ")),a.strokeWidthSpan=$("<span>"),o.append(a.strokeWidthSpan).append("<br>"),a.strokeWidth=$("<input>").attr({type:"range",max:150,min:0,value:t.strokeWidth}).addClass("canvasPaintSlider"),o.append(a.strokeWidth),a.strokeWidth.on("input change",a.brushAdjusted),o.append("<br>"),o.append($("<label>").html("Stroke Opacity: ")),a.strokeOpacitySpan=$("<span>"),o.append(a.strokeOpacitySpan).append("%<br>"),a.strokeOpacity=$("<input>").attr({type:"range",max:100,min:0,value:100*t.strokeOpacity}).addClass("canvasPaintSlider"),o.append(a.strokeOpacity),a.strokeOpacity.on("input change",a.brushAdjusted),a.brushToolPreview=$("<canvas>").attr({height:150,width:150}).addClass("canvasPaintBrushPreview"),a.innerToolDiv.append($("<div>").addClass("canvasPaintToolOptionDiv canvasPaintCenter").css("order",3).append(a.brushToolPreview)),a.brushAdjusted(),a.icon.addClass("canvasPaintImgButtonSelected"),t.toolNameSpan.html("Eraser"),t.currTool=a},unselect:function(){var e=t.eraser;e.icon.removeClass("canvasPaintImgButtonSelected"),e.innerToolDiv.remove()},addIcon:function(e){var a=t.eraser;a.icon=$("<img>").css("order",e).attr({src:"resources/eraser.png",alt:"Eraser",title:"Eraser"}).addClass("canvasPaintImgButton").click({tool:a},t.setTool),t.drawingToolsGroup.append(a.icon)},brushAdjusted:function(e){var a=t.eraser;t.strokeWidth=a.strokeWidth.val(),t.strokeOpacity=a.strokeOpacity.val()/100,a.strokeWidthSpan.html(t.strokeWidth),a.strokeOpacitySpan.html(a.strokeOpacity.val());var o=a.brushToolPreview[0].getContext("2d");o.clearRect(0,0,o.canvas.width,o.canvas.height),o.fillStyle="#000000",o.globalAlpha=t.strokeOpacity,o.beginPath(),o.arc(o.canvas.width/2,o.canvas.height/2,t.strokeWidth/2,0,2*Math.PI),o.fill()},drawTool:function(){t.owner.mainContext.fillStyle="#000000",t.owner.mainContext.globalAlpha=t.strokeOpacity,t.owner.mainContext.beginPath(),t.owner.mainContext.arc(t.owner.mousePosition.x,t.owner.mousePosition.y,t.strokeWidth/2,0,2*Math.PI),t.owner.mainContext.fill()}},t.rectangle={doAction:function(e){e.tool="rectangle";var a=e.layer;if(a.show&&(0==a.objects.length||e.dragging||(a.canvasPaint=!1,t.owner.LM.addNewLayer(a.order+1),e.layer=t.owner.LM.currLayer,a=t.owner.LM.currLayer,a.canvasPaint=!0),0!=a.objects.length||e.dragging?"rectangle"==a.type&&a.currObj.updateRectangle(e):(e.order=0,a.type="rectangle",a.objects.push(new t.owner.OF.rectangleObject(e)),a.currObj=a.objects[0]),a.redraw(),!e.dragging)){var o={tool:"rectangle",layer:e.layer,obj:a.currObj};a.actions.push(o),t.owner.AM.addToHistory({tool:"rectangle",layer:e.layer})}},undo:function(e){var t=e.layer.actions.pop();return t.obj.delCanvas(),t.layer.type=void 0,t.layer.objects.pop(),e.layer.undone.push(t),e.layer.redraw(),e},redo:function(e){var t=e.layer.undone.pop();return t.layer.objects.push(t.obj),t.obj.genCanvas(),t.layer.type="rectangle",e.layer.actions.push(t),e.layer.redraw(),e},select:function(e){var a=t.rectangle;a.innerToolDiv=$("<div>").addClass("canvasPaintToolsInnerDiv"),t.scrollingToolDiv.append(a.innerToolDiv);var o=$("<div>").addClass("canvasPaintToolOptionDiv").css("order",0);a.innerToolDiv.append(o.append($("<label>").html("Fill Color: "))),a.fillColor=$("<input>").attr({type:"color",value:t.fillColor}).addClass("canvasPaintoutlineOption").on("input change",a.brushAdjusted),o.append(a.fillColor);var n=$("<div>").css("Order",1).addClass("canvasPaintToolOptionDiv");a.innerToolDiv.append(n),n.append($("<label>").html("Fill Opacity: ")),a.fillOpacitySpan=$("<span>"),n.append(a.fillOpacitySpan).append("%<br>"),a.fillOpacity=$("<input>").attr({type:"range",max:100,min:0,value:100*t.fillOpacity}).addClass("canvasPaintSlider"),n.append(a.fillOpacity),a.fillOpacity.on("input change",a.brushAdjusted);var r=$("<div>").addClass("canvasPaintToolOptionDiv").css("order",0);a.innerToolDiv.append(r.append($("<label>").html("outline Color: "))),a.outlineColor=$("<input>").attr({type:"color",value:t.outlineColor}).addClass("canvasPaintoutlineOption").on("input change",a.brushAdjusted),r.append(a.outlineColor);var i=$("<div>").css("Order",1).addClass("canvasPaintToolOptionDiv");a.innerToolDiv.append(i),i.append($("<label>").html("outline Width: ")),a.outlineWidthSpan=$("<span>"),i.append(a.outlineWidthSpan).append("<br>"),a.outlineWidth=$("<input>").attr({type:"range",max:25,min:0,value:t.outlineWidth}).addClass("canvasPaintSlider"),i.append(a.outlineWidth),a.outlineWidth.on("input change",a.brushAdjusted),i.append("<br>"),i.append($("<label>").html("outline Opacity: ")),a.outlineOpacitySpan=$("<span>"),i.append(a.outlineOpacitySpan).append("%<br>"),a.outlineOpacity=$("<input>").attr({type:"range",max:100,min:0,value:100*t.outlineOpacity}).addClass("canvasPaintSlider"),i.append(a.outlineOpacity),a.outlineOpacity.on("input change",a.brushAdjusted),a.brushToolPreview=$("<canvas>").attr({height:150,width:150}).addClass("canvasPaintBrushPreview"),a.innerToolDiv.append($("<div>").addClass("canvasPaintToolOptionDiv canvasPaintCenter").css("order",3).append(a.brushToolPreview)),a.brushAdjusted(),a.icon.addClass("canvasPaintImgButtonSelected"),t.toolNameSpan.html("Rectangle Tool"),t.currTool=a},unselect:function(){var e=t.rectangle;e.icon.removeClass("canvasPaintImgButtonSelected"),e.innerToolDiv.remove()},addIcon:function(e){var a=t.rectangle;a.icon=$("<img>").css("order",e).attr({src:"resources/rectangle.png",alt:"Rectangle",title:"Rectangle"}).addClass("canvasPaintImgButton").click({tool:a},t.setTool),t.drawingToolsGroup.append(a.icon)},brushAdjusted:function(){var e=t.rectangle;t.fillColor=e.fillColor.val(),t.fillOpacity=e.fillOpacity.val()/100,t.outlineColor=e.outlineColor.val(),t.outlineWidth=e.outlineWidth.val(),t.outlineOpacity=e.outlineOpacity.val()/100,e.outlineWidthSpan.html(t.outlineWidth),e.fillOpacitySpan.html(e.fillOpacity.val()),e.outlineOpacitySpan.html(e.outlineOpacity.val());var a=e.brushToolPreview[0].getContext("2d");a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=t.fillColor,a.globalAlpha=t.fillOpacity,a.fillRect(30,30,90,90),t.outlineWidth*t.outlineOpacity>0&&(a.beginPath(),a.strokeStyle=t.outlineColor,a.lineWidth=t.outlineWidth,a.globalAlpha=t.outlineOpacity,a.moveTo(30-t.outlineWidth/2,30-t.outlineWidth/2),a.lineTo(120+t.outlineWidth/2,30-t.outlineWidth/2),a.lineTo(120+t.outlineWidth/2,120+t.outlineWidth/2),a.lineTo(30-t.outlineWidth/2,120+t.outlineWidth/2),a.closePath(),a.stroke())},drawTool:function(){var e=t.owner.mainContext,a=t.owner.mousePosition,o=15,n=3;e.strokeStyle="#000000",e.lineWidth=2,e.globalAlpha=1,e.beginPath(),e.moveTo(a.x-n,a.y),e.lineTo(a.x-o,a.y),e.stroke(),e.beginPath(),e.moveTo(a.x,a.y-n),e.lineTo(a.x,a.y-o),e.stroke(),e.beginPath(),e.moveTo(a.x+n,a.y),e.lineTo(a.x+o,a.y),e.stroke(),e.beginPath(),e.moveTo(a.x,a.y+n),e.lineTo(a.x,a.y+o),e.stroke()}},t.addLayer={doAction:function(e){var a=e.manager;if(e.order){a.layers.splice(e.order,0,new a.layer),a.useLayer(a.layers[e.order]);for(var o=e.order;o<a.layers.length;o++)a.layers[o].setOrder(o)}else a.layers.push(new a.layer),a.useLayer(a.layers[a.layers.length-1]);a.currLayer.actions.push({tool:"addLayer",layer:a.currLayer}),t.owner.AM.addToHistory({tool:"addLayer",layer:a.currLayer})},undo:function(e){var t=e.layer,a=(t.manager,t.actions.pop());t.miniLayerDiv.remove();var o,n=!1,r=t.manager.currLayer.id==t.id;for(o=0;o<t.manager.layers.length;o++)t.manager.layers[o].id==t.id&&(t.manager.layers.splice(o,1),n=!0,r&&(0!=o?t.manager.useLayer(t.manager.layers[o-1]):o<t.manager.layers.length?t.manager.useLayer(t.manager.layers[o]):t.manager.currLayer=void 0)),n&&o<t.manager.layers.length&&t.manager.layers[o].setOrder(o);return t.undone.push(a),e},redo:function(e){var t=e.layer,a=t.manager,o=t.undone.pop();t.manager.layers.splice(t.order,0,t),t.genHTML();for(var n=0;n<t.manager.layers.length;n++)t.manager.layers[n].setOrder(n);return o.wasCurr&&t.manager.useLayer(t),a.useLayer(t),t.redraw(),t.actions.push(o),e}},t.toggleLayerVisibility={doAction:function(e){lbase=e.layer,this.action(lbase),lbase.actions.push({tool:"toggleLayerVisibility",layer:lbase}),t.owner.AM.addToHistory({tool:"toggleLayerVisibility",layer:lbase})},undo:function(e){return lbase=e.layer,this.action(lbase),lbase.undone.push(lbase.actions.pop()),e},redo:function(e){return lbase=e.layer,this.action(lbase),lbase.actions.push(lbase.undone.pop()),e},action:function(e){e.show=!e.show,e.show?(e.visibilityToggleButton.attr("src","resources/openEye.png"),e.objects.forEach(function(e){e.show()})):(e.visibilityToggleButton.attr("src","resources/closedEye.png"),e.objects.forEach(function(e){e.hide()}))}},t.clear={doAction:function(e){e.layer.actions.push({tool:"clear",objects:e.layer.objects.slice(),erased:e.layer.erased.slice()}),e.layer.objects.forEach(function(e){e.delCanvas()}),e.layer.objects=[],e.layer.erased=[],t.owner.AM.addToHistory({tool:"clear",layer:e.layer}),e.layer.redraw()},undo:function(e){var t=e.layer.actions.pop();return e.layer.objects=t.objects,e.layer.erased=t.erased,e.layer.objects.forEach(function(e){e.genCanvas()}),e.layer.undone.push({tool:"clear"}),e.layer.redraw(),{tool:"clear",layer:e.layer}},redo:function(e){e.layer.undone.pop();return e.layer.actions.push({tool:"clear",objects:e.layer.objects.slice(),erased:e.layer.erased.slice()}),e.layer.objects.forEach(function(e){e.delCanvas()}),e.layer.objects=[],e.layer.redraw(),{tool:"clear",layer:e.layer}}},t.deleteLayer={doAction:function(e){e.layer.miniLayerDiv.remove();for(var a=!1,o=e.layer.manager.currLayer.id==e.layer.id,n=0;n<e.layer.manager.layers.length;n++)e.layer.manager.layers[n].id==e.layer.id&&(e.layer.manager.layers.splice(n,1),a=!0,o&&(0!=n?e.layer.manager.useLayer(e.layer.manager.layers[n-1]):n<e.layer.manager.layers.length?e.layer.manager.useLayer(e.layer.manager.layers[n]):e.layer.manager.currLayer=void 0)),a&&n<e.layer.manager.layers.length&&e.layer.manager.layers[n].setOrder(n);e.layer.objects.forEach(function(e){e.delCanvas()}),e.layer.actions.push({tool:"deleteLayer",layer:e.layer,wasCurr:o}),t.owner.AM.addToHistory({tool:"deleteLayer",layer:e.layer})},undo:function(e){var t=e.layer.actions.pop();t.layer.manager.layers.splice(t.layer.order,0,t.layer),t.layer.genHTML(),t.layer.objects.forEach(function(e){e.genCanvas()}),t.layer.undone.push(t);for(var a=0;a<t.layer.manager.layers.length;a++)t.layer.manager.layers[a].setOrder(a);return t.wasCurr&&t.layer.manager.useLayer(t.layer),t.layer.redraw(),e},redo:function(e){var t=e.layer.undone.pop();t.layer.miniLayerDiv.remove();var a,o=!1,n=t.layer.manager.currLayer.id==t.layer.id;for(a=0;a<t.layer.manager.layers.length;a++)t.layer.manager.layers[a].id==t.layer.id&&(t.layer.manager.layers.splice(a,1),o=!0,n&&(0!=a?t.layer.manager.useLayer(t.layer.manager.layers[a-1]):a<t.layer.manager.layers.length?t.layer.manager.useLayer(t.layer.manager.layers[a]):t.layer.manager.currLayer=void 0)),o&&a<t.layer.manager.layers.length&&t.layer.manager.layers[a].setOrder(a);return t.layer.objects.forEach(function(e){e.delCanvas()}),t.layer.actions.push(t),e}},t.moveLayerUp={doAction:function(e){for(var a=e.layer,o=a.manager,n=0;n<o.layers.length;n++)if(o.layers[n].id==a.id&&n<o.layers.length-1)return o.layers[n]=o.layers[n+1],o.layers[n+1]=a,a.setOrder(n+1),o.layers[n].setOrder(n),a.actions.push({tool:"moveLayerUp",layer:a}),void t.owner.AM.addToHistory({tool:"moveLayerUp",layer:a})},undo:function(e){for(var t=e.layer,a=t.manager,o=t.actions.pop(),n=0;n<a.layers.length;n++)if(a.layers[n].id==t.id&&n>0)return a.layers[n]=a.layers[n-1],a.layers[n-1]=t,t.setOrder(n-1),a.layers[n].setOrder(n),t.undone.push(o),e},redo:function(e){for(var t=e.layer,a=t.manager,o=t.undone.pop(),n=0;n<a.layers.length;n++)if(a.layers[n].id==t.id&&n<a.layers.length-1)return a.layers[n]=a.layers[n+1],a.layers[n+1]=t,t.setOrder(n+1),a.layers[n].setOrder(n),t.actions.push(o),e}},t.moveLayerDown={doAction:function(e){for(var a=e.layer,o=a.manager,n=0;n<o.layers.length;n++)if(o.layers[n].id==a.id&&n>0)return o.layers[n]=o.layers[n-1],o.layers[n-1]=a,a.setOrder(n-1),o.layers[n].setOrder(n),a.actions.push({tool:"moveLayerDown",layer:a}),void t.owner.AM.addToHistory({tool:"moveLayerDown",layer:a})},undo:function(e){for(var t=e.layer,a=t.manager,o=t.actions.pop(),n=0;n<a.layers.length;n++)if(a.layers[n].id==t.id&&n<a.layers.length-1)return a.layers[n]=a.layers[n+1],a.layers[n+1]=t,t.setOrder(n+1),a.layers[n].setOrder(n),t.undone.push(o),e},redo:function(e){for(var t=e.layer,a=t.manager,o=t.undone.pop(),n=0;n<a.layers.length;n++)if(a.layers[n].id==t.id&&n>0)return a.layers[n]=a.layers[n-1],a.layers[n-1]=t,t.setOrder(n-1),a.layers[n].setOrder(n),t.actions.push(o),e}},t.changeLayerOpacity={doAction:function(e){var a=e.layer,o=a.opacitySlider.val()/100,n=a.actions[a.actions.length-1];
e.dragging?n&&"changeLayerOpacity"==n.tool&&n.dragging?n.valueTo=o:(a.actions.push({tool:"changeLayerOpacity",dragging:!0,valueTo:o,valueFrom:a.opacity}),t.owner.AM.addToHistory({tool:"changeLayerOpacity",layer:a})):"changeLayerOpacity"==n.tool&&n.dragging?(n.valueTo=o,n.dragging=!1):(a.actions.push({tool:"changeLayerOpacity",dragging:!1,valueTo:o,valueFrom:a.opacity}),t.owner.AM.addToHistory({tool:"changeLayerOpacity",layer:a})),a.objects.forEach(function(e){e.isBlank=!1}),a.opacity=o,a.opacitySpan.html(a.opacitySlider.val()),a.redraw()},undo:function(e){var t=e.layer,a=t.actions.pop();return console.log(a),t.opacity=a.valueFrom,t.opacitySpan.html(Math.round(100*a.valueFrom)),t.opacitySlider.val(100*a.valueFrom),t.undone.push(a),t.redraw(),e},redo:function(e){var t=e.layer,a=t.undone.pop();return console.log(a),t.opacity=a.valueTo,t.opacitySpan.html(Math.round(100*a.valueTo)),t.opacitySlider.val(100*a.valueTo),t.actions.push(a),t.redraw(),e}},t["export"]={addIcon:function(e){var a=t["export"];t.exportToolGroup.append($("<label>").html("Export as:")),a.exportFilename=$("<input>").attr({type:"text",placeholder:"drawing"}).addClass("canvasPaintExportFilename"),t.exportToolGroup.append(a.exportFilename),t.exportToolGroup.append(".png"),a.exportButton=$("<span>").html("Export").addClass("canvasPaintImgButton").click(a.exportDrawing),t.exportToolGroup.append(a.exportButton)},exportDrawing:function(e){var a=t["export"],o=t.owner;o.mainContext.clearRect(0,0,o.mainContext.canvas.width,o.mainContext.canvas.height),o.mainContext.globalAlpha=1,o.LM.layers.forEach(function(e){e.drawOnGlobal()}),o.mainCanvas[0].toBlobHD(function(e){saveAs(e,(a.exportFilename.val()||a.exportFilename.attr("placeholder"))+".png")},"image/png"),o.mainContext.clearRect(0,0,o.mainContext.canvas.width,o.mainContext.canvas.height)}},t.history={addIcon:function(e){var a=t.history;t.historyToolGroup.append($("<img>").css("order",0).addClass("canvasPaintImgButton").attr({src:"resources/undo.png",alt:"Undo",title:"Undo"}).click(a.undo)).append($("<img>").css("order",1).addClass("canvasPaintImgButton").attr({src:"resources/redo.png",alt:"Redo",title:"Redo"}).click(a.redo)),$("body").keydown(a.keyDown)},undo:function(e){t.owner.AM.undo()},redo:function(e){t.owner.AM.redo()},keyDown:function(e){e=e||window.event;var a=t.history;90!=e.which&&90!=e.keyCode||!e.ctrlKey?89!=e.which&&89!=e.keyCode||!e.ctrlKey||a.redo():a.undo()}}}!function(e,t,a){e.boglePlugin||(e.boglePlugin={});var o=e("<link>");e("head").append(o),o.attr({rel:"stylesheet",type:"text/css",href:"resources/canvasPaint.css"}),e.boglePlugin.drawing=function(t,a,o){var n=this;n.$el=e(t),n.el=t,n.$el.data("boglePlugin.drawing",n),n.init=function(){n.functionParam=a,n.options=e.extend({},e.boglePlugin.drawing.defaultOptions,o),n.mousePosition={},n.AM=new CanvasPaintActionManager(n),n.TM=new CanvasPaintToolManager(n),n.OF=new CanvasPaintObjectFactory(n),n.LM=new CanvasPaintLayerManager(n);var t=e("<section>").addClass("canvasPaintMain");n.$el.append(t),n.topSect=e("<section>").addClass("canvasPaintTopSect"),t.append(n.topSect);var r=e("<section>").addClass("canvasPaintMiddleSect");t.append(r);var i=e("<div>").addClass("canvasPaintLayersOuterDiv").css("order",0);r.append(i),i.append(e("<strong>").html("Layers ")),n.addNewLayerButton=e("<img>").attr({src:"resources/add.png",alt:"Add New Layer",title:"Add New Layer"}).addClass("canvasPaintImgButton"),i.append(n.addNewLayerButton),n.addNewLayerButton.click(n.addNewLayer);var s=e("<div>").addClass("canvasPaintLayersScrollingDiv");i.append(s),n.layersInnerDiv=e("<div>").addClass("canvasPaintLayersInnerDiv"),s.append(n.layersInnerDiv),n.canvasDiv=e("<div>").addClass("canvasPaintMainCanvasDiv").css("order",1),n.canvasScrollingDiv=e("<div>").addClass("canvasPaintMainCanvasScrollingDiv"),n.canvasInnerDiv=e("<div>").addClass("canvasPaintMainCanvasInnerDiv"),n.canvasDiv.append(n.canvasScrollingDiv.append(n.canvasInnerDiv)),r.append(n.canvasDiv),n.mainCanvas=e("<canvas>").attr({height:n.options.canvHeight,width:n.options.canvWidth}).addClass("canvasPaintMainCanvas"),n.canvasInnerDiv.append(n.mainCanvas),n.mainContext=n.mainCanvas[0].getContext("2d"),n.mainCanvas.on("mousedown mousemove touchstart touchmove",n.canvasMouseDownMove),n.mainCanvas.on("mouseup mouseleave touchend",n.canvasMouseUpLeave),n.mainCanvas.on("contextmenu",n.canvasContextMenu),n.outerToolDiv=e("<div>").addClass("canvasPaintToolsOuterDiv").css("order",2),r.append(n.outerToolDiv),n.LM.blankData=n.mainCanvas[0].toDataURL(),e("body").keydown(n.keyDown),n.addNewLayer(),n.TM.setUpTools(),n.AM.history.pop(),n.LM.layers[0].actions.pop(),console.log("Canvas Paint: Ready to draw!")},n.addNewLayer=function(){n.LM.addNewLayer()},n.undo=function(e){n.AM.undo()},n.redo=function(e){n.AM.redo()},n.getMousePosition=function(e){if("mouseleave"==e.type)return void(n.mousePosition.offCanvas=!0);n.mousePosition.offCanvas=!1;var t=n.mainCanvas[0].getBoundingClientRect();"touchstart"==e.type||"touchmove"==e.type?(n.mousePosition.x=e.originalEvent.changedTouches[0].clientX-t.left,n.mousePosition.y=e.originalEvent.changedTouches[0].clientY-t.top):(n.mousePosition.x=e.clientX-t.left,n.mousePosition.y=e.clientY-t.top)},n.canvasMouseDownMove=function(e){if(e.preventDefault(),n.getMousePosition(e),!(e.which>1)){var t;"mousedown"==e.type||"touchstart"==e.type?(t=!1,n.LM.currLayer.canvasPaint=!0):("mousemove"==e.type||"touchmove"==e.type)&&(t=!0);var a={layer:n.LM.currLayer,mX:n.mousePosition.x,mY:n.mousePosition.y,dragging:t};n.LM.currLayer.canvasPaint&&n.TM.currTool.doAction(a),n.redrawBrush()}},n.canvasMouseUpLeave=function(e){n.LM.currLayer.canvasPaint&&e.which<=1&&(n.LM.currLayer.canvasPaint=!1),n.getMousePosition(e),n.redrawBrush()},this.canvasContextMenu=function(e){e.preventDefault()},n.drawBrush=function(){n.mousePosition.offCanvas||n.TM.currTool.drawTool()},n.redrawBrush=function(){n.mainContext.clearRect(0,0,n.mainContext.canvas.width,n.mainContext.canvas.height),n.drawBrush()},n.init()},e.boglePlugin.drawing.defaultOptions={canvWidth:700,canvHeight:394,currTool:"paint",strokeColor:"#ff0000",strokeWidth:20,strokeOpacity:100,fillColor:"#ff0000",fillOpacity:100,outlineColor:"#000000",outlineWidth:2,outlineOpacity:100},e.fn.boglePlugin_drawing=function(t,a){return this.each(function(){new e.boglePlugin.drawing(this,t,a)})},e(t).ready(function(){e(".canvasPaint").boglePlugin_drawing()})}(jQuery);